saravanans@myvm24:~/tf_azurebackend_vm$ 
saravanans@myvm24:~/tf_azurebackend_vm$
saravanans@myvm24:~/tf_azurebackend_vm$ cat > robochef_stack.sh
echo "beginning the execution of robochef stack"
sudo apt update
sudo apt install apache2 -y
sudo apt-get update
sudo apt-get install -y software-properties-common
sudo apt-get install -y python-setuptools python-dev libffi-dev libssl-dev git sshpass tree
sudo easy_install pip
sudo apt install ansible -y 

ansible --version
saravanans@myvm24:~/tf_azurebackend_vm$ mkdir files
saravanans@myvm24:~/tf_azurebackend_vm$ cat > files/ansible-playbook.yaml
---
- hosts: localhost
  sudo: yes
  vars:
    motd_warning: 'RoboChef the worlds First fully automated Robbotic Kitchen'
    admatic_note: 'Admatic works'
  tasks:
    - name: setup a MOTD
      copy: dest=/etc/motd content={{ motd_warning }}
    - name: Another task to demonsntrate ansible from terraform
      copy: dest=/opt/admaticworks content={{ admatic_note }}
saravanans@myvm24:~/tf_azurebackend_vm$


saravanans@myvm24:~/tf_azurebackend_vm$
saravanans@myvm24:~/tf_azurebackend_vm$ cat main.tf
resource "azurerm_resource_group" "myterraformgroup" {
  name     = "admatic-rg-network-demo"
  location = var.location
}

resource "azurerm_virtual_network" "myterraformnetwork" {
  name                = "myVnet"
  address_space       = ["10.0.0.0/16"]
  location            = var.location
  resource_group_name = azurerm_resource_group.myterraformgroup.name
}

resource "azurerm_subnet" "myterraformsubnet" {
  name                 = "mySubnnet"
  resource_group_name  = azurerm_resource_group.myterraformgroup.name
  virtual_network_name = azurerm_virtual_network.myterraformnetwork.name
  address_prefixes     = ["10.0.1.0/24"]
}

resource "azurerm_network_security_group" "myterraformnsg" {
  name                = "myNetworkSecurityGroup"
  location            = var.location
  resource_group_name = azurerm_resource_group.myterraformgroup.name

  security_rule {
    name                       = "Web"
    priority                   = 1001
    direction                  = "Inbound"
    access                     = "Allow"
    protocol                   = "Tcp"
    source_port_range          = "*"
    destination_port_range     = var.ssh_port
    source_address_prefix      = "*"
    destination_address_prefix = "*"
  }
}

resource "azurerm_network_interface" "myterraformnic" {
  name                = "myNIC"
  location            = var.location
  resource_group_name = azurerm_resource_group.myterraformgroup.name

  ip_configuration {
    name                          = "myNicConfiguration"
    subnet_id                     = azurerm_subnet.myterraformsubnet.id
    private_ip_address_allocation = "Dynamic"
    public_ip_address_id        = azurerm_public_ip.myterraformpublicip.id
  }
}

resource "azurerm_network_interface_security_group_association" "example" {
  network_interface_id      = azurerm_network_interface.myterraformnic.id
  network_security_group_id = azurerm_network_security_group.myterraformnsg.id
}

resource "azurerm_public_ip" "myterraformpublicip" {
  name                = "myPublicIP"
  location            = var.location
  resource_group_name = azurerm_resource_group.myterraformgroup.name
  allocation_method   = "Dynamic"

}

resource "azurerm_linux_virtual_machine" "myterraformvm" {
  name                  = "myAdmaticVM"
  location              = var.location
  resource_group_name   = azurerm_resource_group.myterraformgroup.name
  network_interface_ids = [azurerm_network_interface.myterraformnic.id]

  size = "Standard_B2s"

  os_disk {
    name                 = "myOsDisk"
    caching              = "ReadWrite"
    storage_account_type = "Premium_LRS"
  }

  source_image_reference {
    publisher = "Canonical"
    offer     = "UbuntuServer"
    sku       = "18.04-LTS"
    version   = "latest"
  }

  admin_username                  = "saravanans"
  admin_password                  = random_string.sshpassword.result
  disable_password_authentication = false
}

resource "random_string" "sshpassword" {
  length  = 20
  special = true
}


resource "null_resource" "remote-provisioner" {
	triggers = {
		trigger = timestamp()

	}
        connection {
                type = "ssh"
                host = azurerm_public_ip.myterraformpublicip.ip_address
                user = "saravanans"
                password =random_string.sshpassword.result
                port = 22
                agent = false

        }

	provisioner "remote-exec" {
		inline = [
			"echo Remote Provisioner did this > /tmp/remoteexec.txt",
			"echo Remote Provisioner Completed first execution ",
			"sh /tmp/robochef_stack.sh",
			"ls -l /tmp",
			"cd /tmp && ansible-playbook ansible-playbook.yaml"

			]
	}
	depends_on = [null_resource.copy_script,null_resource.copy_playbook]

}



resource "null_resource" "copy_script" {

        triggers = {
                trigger = timestamp()

        }
        connection {
                type = "ssh"
                host = azurerm_public_ip.myterraformpublicip.ip_address
                user = "saravanans"
                password =random_string.sshpassword.result
                port = 22
                agent = false

        }
        provisioner "file" {
                source = "robochef_stack.sh"
                destination = "/tmp/robochef_stack.sh"
        }

}

resource "null_resource" "copy_playbook" {

        triggers = {
                trigger = timestamp()

        }
        connection {
                type = "ssh"
                host = azurerm_public_ip.myterraformpublicip.ip_address
                user = "saravanans"
                password =random_string.sshpassword.result
                port = 22
                agent = false

        }

        provisioner "file" {
                source = "files/ansible-playbook.yaml"
                destination = "/tmp/ansible-playbook.yaml"
        }

}



saravanans@ubuntu:~/admatic_terraform_workspace$ 
saravanans@ubuntu:~/admatic_terraform_workspace$ mkdir ansible_terraform_integration
saravanans@ubuntu:~/admatic_terraform_workspace$ cd ansible_terraform_integration
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ 
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ cp ../remoteexec_demo/*.tf .
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ ls
main.tf

saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ ls
main.tf
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ cp ../remoteexec_demo/*.sh .
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ cp ../remoteexec_demo/*.txt .
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ ls
main.tf  robochef_stack.sh  robochef_stack.txt
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ 

saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ ls
main.tf  robochef_stack.sh  robochef_stack.txt
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ cat main.tf 
provider "azurerm" {
	features {}
}

resource "azurerm_resource_group" "myterraformgroup" {
    name     = "myResourceGroup"
    location = "eastus"
}

resource "azurerm_virtual_network" "myterraformnetwork" {
	name = "myVnet"
	address_space = ["10.0.0.0/16"]
	location = "eastus"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
}

resource "azurerm_public_ip" "myterraformpublicip" {
    name                         = "myPublicIP"
    location                     = "eastus"
    resource_group_name          = azurerm_resource_group.myterraformgroup.name
    allocation_method            = "Dynamic"
}


resource "azurerm_subnet" "myterraformsubnet" {
	name = "mySubnet"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
	virtual_network_name = azurerm_virtual_network.myterraformnetwork.name
	address_prefixes = ["10.0.1.0/24"]
}

resource "azurerm_network_security_group" "myterraformnsg" {
    name                = "myNetworkSecurityGroup"
    location            = "eastus"
    resource_group_name = azurerm_resource_group.myterraformgroup.name

    security_rule {
        name                       = "Web"
        priority                   = 1001
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "Tcp"
        source_port_range          = "*"
        destination_port_range     = "22"
        source_address_prefix      = "*"
        destination_address_prefix = "*"
    }
}

resource "azurerm_network_interface" "myterraformnic" {
    name                      = "myNIC"
    location                  = "eastus"
    resource_group_name       = azurerm_resource_group.myterraformgroup.name

    ip_configuration {
        name                          = "myNicConfiguration"
        subnet_id                     = azurerm_subnet.myterraformsubnet.id
        private_ip_address_allocation = "Dynamic"
        public_ip_address_id          = azurerm_public_ip.myterraformpublicip.id
    }
}


resource "azurerm_network_interface_security_group_association" "example" {
    network_interface_id      = azurerm_network_interface.myterraformnic.id
    network_security_group_id = azurerm_network_security_group.myterraformnsg.id
}


resource "azurerm_linux_virtual_machine" "myterraformvm" {
    name                  = "admaticmyVM"
    location              = "eastus"
    resource_group_name   = azurerm_resource_group.myterraformgroup.name
    network_interface_ids = [azurerm_network_interface.myterraformnic.id]
    #size                  = "Standard_DS1_v2"
    size                  = "Standard_B1s"

    os_disk {
        name              = "myOsDisk"
        caching           = "ReadWrite"
        storage_account_type = "Premium_LRS"
    }

    source_image_reference {
        publisher = "Canonical"
        offer     = "UbuntuServer"
        sku       = "18.04-LTS"
        version   = "latest"
    }

    admin_username = "admatic"
    admin_password = "Sincere-Compete-Spoil-Private-3"
    disable_password_authentication = false
    

}

output "public_ip" {
  value = azurerm_public_ip.myterraformpublicip.ip_address
  description = "The public IP address of the vm"
}

resource "null_resource" "remote-provisioner" {
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "remote-exec" {
		inline = [
			"echo Remote Provisioner did this > /tmp/remoteexec.txt",
			"echo Remote Provisioner Completed first execution ",
			"sh /home/admatic/robochef_stack.sh",
			"ls -l /tmp"
			]
	}
	depends_on = [null_resource.copy_script]

}

resource "null_resource" "copy_script" {
	
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "file" {
		source = "robochef_stack.sh"
		destination = "/home/admatic/robochef_stack.sh"
	}

}
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ ls
main.tf  robochef_stack.sh  robochef_stack.txt
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ 
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ ls
main.tf  robochef_stack.sh  robochef_stack.txt
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ rm robochef_stack.txt 
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ ls
main.tf  robochef_stack.sh
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ ls
main.tf  robochef_stack.sh
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ vi ansible_install.sh
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ ssh admatic@20.106.240.50
admatic@20.106.240.50's password: 
Welcome to Ubuntu 18.04.6 LTS (GNU/Linux 5.4.0-1059-azure x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Mon Oct 11 06:44:46 UTC 2021

  System load:  0.0               Processes:           111
  Usage of /:   5.2% of 28.90GB   Users logged in:     0
  Memory usage: 26%               IP address for eth0: 10.0.1.4
  Swap usage:   0%


8 updates can be applied immediately.
4 of these updates are standard security updates.
To see these additional updates run: apt list --upgradable

New release '20.04.3 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


Last login: Mon Oct 11 06:16:15 2021 from 49.37.223.189
admatic@admaticmyVM:~$ 



admatic@admaticmyVM:~$ 
admatic@admaticmyVM:~$ 
admatic@admaticmyVM:~$ sudo apt-get update
Hit:1 http://azure.archive.ubuntu.com/ubuntu bionic InRelease
Hit:2 http://azure.archive.ubuntu.com/ubuntu bionic-updates InRelease
Hit:3 http://azure.archive.ubuntu.com/ubuntu bionic-backports InRelease
Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease
0% [1 InRelease gpgv 242 kB]                      
Reading package lists... Done
admatic@admaticmyVM:~$ 
admatic@admaticmyVM:~$ sudo apt-get install -y software-properties-common
Reading package lists... Done
Building dependency tree       
Reading state information... Done

software-properties-common is already the newest version (0.96.24.32.14).
software-properties-common set to manually installed.
The following package was automatically installed and is no longer required:
  linux-headers-4.15.0-159
Use 'sudo apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 8 not upgraded.
admatic@admaticmyVM:~$ 
admatic@admaticmyVM:~$ sudo apt-get install -y python-setuptools python-dev libffi-dev libssl-dev git sshpass tree
Reading package lists... Done
Building dependency tree... 50%
Building dependency tree       
Reading state information... Done
git is already the newest version (1:2.17.1-1ubuntu0.9).
git set to manually installed.
The following package was automatically installed and is no longer required:
  linux-headers-4.15.0-159
Use 'sudo apt autoremove' to remove it.
The following additional packages will be installed:
  libc-dev-bin libc6-dev libexpat1-dev libpython-dev libpython2.7-dev linux-libc-dev manpages-dev
  python-pkg-resources python2.7-dev
Suggested packages:
  glibc-doc libssl-doc python-setuptools-doc
The following NEW packages will be installed:
  libc-dev-bin libc6-dev libexpat1-dev libffi-dev libpython-dev libpython2.7-dev libssl-dev
  linux-libc-dev manpages-dev python-dev python-pkg-resources python-setuptools python2.7-dev sshpass
  tree
0 upgraded, 15 newly installed, 0 to remove and 8 not upgraded.
Need to get 36.8 MB of archives.
After this operation, 82.7 MB of additional disk space will be used.
Get:1 http://azure.archive.ubuntu.com/ubuntu bionic-updates/main amd64 libc-dev-bin amd64 2.27-3ubuntu1.4 [71.8 kB]
Get:2 http://azure.archive.ubuntu.com/ubuntu bionic-updates/main amd64 linux-libc-dev amd64 4.15.0-159.167 [995 kB]
Get:3 http://azure.archive.ubuntu.com/ubuntu bionic-updates/main amd64 libc6-dev amd64 2.27-3ubuntu1.4 [2585 kB]
Get:4 http://azure.archive.ubuntu.com/ubuntu bionic-updates/main amd64 libexpat1-dev amd64 2.2.5-3ubuntu0.2 [122 kB]
Get:5 http://azure.archive.ubuntu.com/ubuntu bionic-updates/main amd64 libpython2.7-dev amd64 2.7.17-1~18.04ubuntu1.6 [28.3 MB]
Get:6 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 libpython-dev amd64 2.7.15~rc1-1 [7684 B]
Get:7 http://azure.archive.ubuntu.com/ubuntu bionic-updates/main amd64 libssl-dev amd64 1.1.1-1ubuntu2.1~18.04.13 [1568 kB]
Get:8 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 manpages-dev all 4.15-1 [2217 kB]
Get:9 http://azure.archive.ubuntu.com/ubuntu bionic-updates/main amd64 python2.7-dev amd64 2.7.17-1~18.04ubuntu1.6 [279 kB]
Get:10 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-dev amd64 2.7.15~rc1-1 [1256 B]
Get:11 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-pkg-resources all 39.0.1-2 [128 kB]
Get:12 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-setuptools all 39.0.1-2 [329 kB]
Get:13 http://azure.archive.ubuntu.com/ubuntu bionic/universe amd64 tree amd64 1.7.0-5 [40.7 kB]
Get:14 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 libffi-dev amd64 3.2.1-8 [156 kB]
Get:15 http://azure.archive.ubuntu.com/ubuntu bionic/universe amd64 sshpass amd64 1.06-1 [10.5 kB]
Fetched 36.8 MB in 1s (51.3 MB/s)
Selecting previously unselected package libc-dev-bin.
(Reading database ... 77667 files and directories currently installed.)
Preparing to unpack .../00-libc-dev-bin_2.27-3ubuntu1.4_amd64.deb ...
Unpacking libc-dev-bin (2.27-3ubuntu1.4) ...
Selecting previously unselected package linux-libc-dev:amd64.
Preparing to unpack .../01-linux-libc-dev_4.15.0-159.167_amd64.deb ...
Unpacking linux-libc-dev:amd64 (4.15.0-159.167) ...
Selecting previously unselected package libc6-dev:amd64.
Preparing to unpack .../02-libc6-dev_2.27-3ubuntu1.4_amd64.deb ...
Unpacking libc6-dev:amd64 (2.27-3ubuntu1.4) ...
Selecting previously unselected package libexpat1-dev:amd64.
Preparing to unpack .../03-libexpat1-dev_2.2.5-3ubuntu0.2_amd64.deb ...
Unpacking libexpat1-dev:amd64 (2.2.5-3ubuntu0.2) ...
Selecting previously unselected package libpython2.7-dev:amd64.
Preparing to unpack .../04-libpython2.7-dev_2.7.17-1~18.04ubuntu1.6_amd64.deb ...
Unpacking libpython2.7-dev:amd64 (2.7.17-1~18.04ubuntu1.6) ...
Selecting previously unselected package libpython-dev:amd64.
Preparing to unpack .../05-libpython-dev_2.7.15~rc1-1_amd64.deb ...
Unpacking libpython-dev:amd64 (2.7.15~rc1-1) ...
Selecting previously unselected package libssl-dev:amd64.
Preparing to unpack .../06-libssl-dev_1.1.1-1ubuntu2.1~18.04.13_amd64.deb ...
Unpacking libssl-dev:amd64 (1.1.1-1ubuntu2.1~18.04.13) ...
Selecting previously unselected package manpages-dev.
Preparing to unpack .../07-manpages-dev_4.15-1_all.deb ...
Unpacking manpages-dev (4.15-1) ...
Selecting previously unselected package python2.7-dev.
Preparing to unpack .../08-python2.7-dev_2.7.17-1~18.04ubuntu1.6_amd64.deb ...
Unpacking python2.7-dev (2.7.17-1~18.04ubuntu1.6) ...
Selecting previously unselected package python-dev.
Preparing to unpack .../09-python-dev_2.7.15~rc1-1_amd64.deb ...
Unpacking python-dev (2.7.15~rc1-1) ...
Selecting previously unselected package python-pkg-resources.
Preparing to unpack .../10-python-pkg-resources_39.0.1-2_all.deb ...
Unpacking python-pkg-resources (39.0.1-2) ...
Selecting previously unselected package python-setuptools.
Preparing to unpack .../11-python-setuptools_39.0.1-2_all.deb ...
Unpacking python-setuptools (39.0.1-2) ...
Selecting previously unselected package tree.
Preparing to unpack .../12-tree_1.7.0-5_amd64.deb ...
Unpacking tree (1.7.0-5) ...
Selecting previously unselected package libffi-dev:amd64.
Preparing to unpack .../13-libffi-dev_3.2.1-8_amd64.deb ...
Unpacking libffi-dev:amd64 (3.2.1-8) ...
Selecting previously unselected package sshpass.
Preparing to unpack .../14-sshpass_1.06-1_amd64.deb ...
Unpacking sshpass (1.06-1) ...
Setting up tree (1.7.0-5) ...
Setting up libssl-dev:amd64 (1.1.1-1ubuntu2.1~18.04.13) ...
Setting up linux-libc-dev:amd64 (4.15.0-159.167) ...
Setting up libffi-dev:amd64 (3.2.1-8) ...
Setting up python-pkg-resources (39.0.1-2) ...
Setting up sshpass (1.06-1) ...
Setting up libc-dev-bin (2.27-3ubuntu1.4) ...
Setting up manpages-dev (4.15-1) ...
Setting up libc6-dev:amd64 (2.27-3ubuntu1.4) ...
Setting up python-setuptools (39.0.1-2) ...
Setting up libexpat1-dev:amd64 (2.2.5-3ubuntu0.2) ...
Setting up libpython2.7-dev:amd64 (2.7.17-1~18.04ubuntu1.6) ...
Setting up python2.7-dev (2.7.17-1~18.04ubuntu1.6) ...
Setting up libpython-dev:amd64 (2.7.15~rc1-1) ...
Setting up python-dev (2.7.15~rc1-1) ...
Processing triggers for install-info (6.5.0.dfsg.1-2) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...

admatic@admaticmyVM:~$ sudo apt install ansible -y
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following package was automatically installed and is no longer required:
  linux-headers-4.15.0-159
Use 'sudo apt autoremove' to remove it.
The following additional packages will be installed:
  ieee-data python-asn1crypto python-certifi python-cffi-backend python-chardet python-cryptography
  python-enum34 python-httplib2 python-idna python-ipaddress python-jinja2 python-jmespath
  python-kerberos python-libcloud python-lockfile python-markupsafe python-netaddr python-openssl
  python-paramiko python-pyasn1 python-requests python-selinux python-simplejson python-urllib3
  python-xmltodict python-yaml
Suggested packages:
  cowsay python-cryptography-doc python-cryptography-vectors python-enum34-doc python-jinja2-doc
  python-lockfile-doc ipython python-netaddr-docs python-openssl-doc python-openssl-dbg python-gssapi
  python-socks python-ntlm
Recommended packages:
  python-winrm
The following NEW packages will be installed:
  ansible ieee-data python-asn1crypto python-certifi python-cffi-backend python-chardet
  python-cryptography python-enum34 python-httplib2 python-idna python-ipaddress python-jinja2
  python-jmespath python-kerberos python-libcloud python-lockfile python-markupsafe python-netaddr
  python-openssl python-paramiko python-pyasn1 python-requests python-selinux python-simplejson
  python-urllib3 python-xmltodict python-yaml
0 upgraded, 27 newly installed, 0 to remove and 8 not upgraded.
Need to get 7776 kB of archives.
After this operation, 60.9 MB of additional disk space will be used.
Get:1 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-asn1crypto all 0.24.0-1 [72.7 kB]
Get:2 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-cffi-backend amd64 1.11.5-1 [63.4 kB]
Get:3 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-enum34 all 1.1.6-2 [34.8 kB]
Get:4 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-idna all 2.6-1 [32.4 kB]
Get:5 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-ipaddress all 1.0.17-1 [18.2 kB]
Get:6 http://azure.archive.ubuntu.com/ubuntu bionic-updates/main amd64 python-cryptography amd64 2.1.4-1ubuntu1.4 [276 kB]
Get:7 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-markupsafe amd64 1.0-1build1 [13.0 kB]
Get:8 http://azure.archive.ubuntu.com/ubuntu bionic-updates/main amd64 python-jinja2 all 2.10-1ubuntu0.18.04.1 [94.8 kB]
Get:9 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-pyasn1 all 0.4.2-3 [46.7 kB]
Get:10 http://azure.archive.ubuntu.com/ubuntu bionic-updates/main amd64 python-paramiko all 2.0.0-1ubuntu1.2 [110 kB]
Get:11 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-yaml amd64 3.12-1build2 [115 kB]
Get:12 http://azure.archive.ubuntu.com/ubuntu bionic-updates/main amd64 python-httplib2 all 0.9.2+dfsg-1ubuntu0.3 [34.9 kB]
Get:13 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 ieee-data all 20180204.1 [1539 kB]
18% [13 ieee-data 0 B/1539 kB 0%]
Get:14 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-netaddr all 0.7.19-1 [213 kB]
Get:15 http://azure.archive.ubuntu.com/ubuntu bionic-updates/universe amd64 ansible all 2.5.1+dfsg-1ubuntu0.1 [3198 kB]
Get:16 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-certifi all 2018.1.18-2 [144 kB]
Get:17 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-chardet all 3.0.4-1 [80.3 kB]
Get:18 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-jmespath all 0.9.3-1ubuntu1 [21.2 kB]
Get:19 http://azure.archive.ubuntu.com/ubuntu bionic/universe amd64 python-kerberos amd64 1.1.14-1 [22.5 kB]
Get:20 http://azure.archive.ubuntu.com/ubuntu bionic-updates/main amd64 python-urllib3 all 1.22-1ubuntu0.18.04.2 [86.0 kB]
Get:21 http://azure.archive.ubuntu.com/ubuntu bionic-updates/main amd64 python-requests all 2.18.4-2ubuntu0.1 [58.5 kB]
Get:22 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-lockfile all 1:0.12.2-2 [14.6 kB]
Get:23 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-simplejson amd64 3.13.2-1 [61.2 kB]
Get:24 http://azure.archive.ubuntu.com/ubuntu bionic/universe amd64 python-libcloud all 2.2.1-1 [1235 kB]
Get:25 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 python-openssl all 17.5.0-1ubuntu1 [41.3 kB]
Get:26 http://azure.archive.ubuntu.com/ubuntu bionic/universe amd64 python-selinux amd64 2.7-2build2 [138 kB]
Get:27 http://azure.archive.ubuntu.com/ubuntu bionic/universe amd64 python-xmltodict all 0.11.0-1 [10.3 kB]
Fetched 7776 kB in 0s (23.1 MB/s)       
Selecting previously unselected package python-asn1crypto.
(Reading database ... 81701 files and directories currently installed.)
Preparing to unpack .../00-python-asn1crypto_0.24.0-1_all.deb ...
Unpacking python-asn1crypto (0.24.0-1) ...
Selecting previously unselected package python-cffi-backend.
Preparing to unpack .../01-python-cffi-backend_1.11.5-1_amd64.deb ...
Unpacking python-cffi-backend (1.11.5-1) ...
Selecting previously unselected package python-enum34.
Preparing to unpack .../02-python-enum34_1.1.6-2_all.deb ...
Unpacking python-enum34 (1.1.6-2) ...
Selecting previously unselected package python-idna.
Preparing to unpack .../03-python-idna_2.6-1_all.deb ...
Unpacking python-idna (2.6-1) ...
Selecting previously unselected package python-ipaddress.
Preparing to unpack .../04-python-ipaddress_1.0.17-1_all.deb ...
Unpacking python-ipaddress (1.0.17-1) ...
Selecting previously unselected package python-cryptography.
Preparing to unpack .../05-python-cryptography_2.1.4-1ubuntu1.4_amd64.deb ...
Unpacking python-cryptography (2.1.4-1ubuntu1.4) ...
Selecting previously unselected package python-markupsafe.
Preparing to unpack .../06-python-markupsafe_1.0-1build1_amd64.deb ...
Unpacking python-markupsafe (1.0-1build1) ...
Selecting previously unselected package python-jinja2.
Preparing to unpack .../07-python-jinja2_2.10-1ubuntu0.18.04.1_all.deb ...
Unpacking python-jinja2 (2.10-1ubuntu0.18.04.1) ...
Selecting previously unselected package python-pyasn1.
Preparing to unpack .../08-python-pyasn1_0.4.2-3_all.deb ...
Unpacking python-pyasn1 (0.4.2-3) ...
Selecting previously unselected package python-paramiko.
Preparing to unpack .../09-python-paramiko_2.0.0-1ubuntu1.2_all.deb ...
Unpacking python-paramiko (2.0.0-1ubuntu1.2) ...
Selecting previously unselected package python-yaml.
Preparing to unpack .../10-python-yaml_3.12-1build2_amd64.deb ...
Unpacking python-yaml (3.12-1build2) ...
Selecting previously unselected package python-httplib2.
Preparing to unpack .../11-python-httplib2_0.9.2+dfsg-1ubuntu0.3_all.deb ...
Unpacking python-httplib2 (0.9.2+dfsg-1ubuntu0.3) ...
Selecting previously unselected package ieee-data.
Preparing to unpack .../12-ieee-data_20180204.1_all.deb ...
Unpacking ieee-data (20180204.1) ...
Selecting previously unselected package python-netaddr.
Preparing to unpack .../13-python-netaddr_0.7.19-1_all.deb ...
Unpacking python-netaddr (0.7.19-1) ...
Selecting previously unselected package ansible.
Preparing to unpack .../14-ansible_2.5.1+dfsg-1ubuntu0.1_all.deb ...
Unpacking ansible (2.5.1+dfsg-1ubuntu0.1) ...
Selecting previously unselected package python-certifi.
Preparing to unpack .../15-python-certifi_2018.1.18-2_all.deb ...
Unpacking python-certifi (2018.1.18-2) ...
Selecting previously unselected package python-chardet.
Preparing to unpack .../16-python-chardet_3.0.4-1_all.deb ...
Unpacking python-chardet (3.0.4-1) ...
Selecting previously unselected package python-jmespath.
Preparing to unpack .../17-python-jmespath_0.9.3-1ubuntu1_all.deb ...
Unpacking python-jmespath (0.9.3-1ubuntu1) ...
Selecting previously unselected package python-kerberos.
Preparing to unpack .../18-python-kerberos_1.1.14-1_amd64.deb ...
Unpacking python-kerberos (1.1.14-1) ...
Selecting previously unselected package python-urllib3.
Preparing to unpack .../19-python-urllib3_1.22-1ubuntu0.18.04.2_all.deb ...
Unpacking python-urllib3 (1.22-1ubuntu0.18.04.2) ...
Selecting previously unselected package python-requests.
Preparing to unpack .../20-python-requests_2.18.4-2ubuntu0.1_all.deb ...
Unpacking python-requests (2.18.4-2ubuntu0.1) ...
Selecting previously unselected package python-lockfile.
Preparing to unpack .../21-python-lockfile_1%3a0.12.2-2_all.deb ...
Unpacking python-lockfile (1:0.12.2-2) ...
Selecting previously unselected package python-simplejson.
Preparing to unpack .../22-python-simplejson_3.13.2-1_amd64.deb ...
Unpacking python-simplejson (3.13.2-1) ...
Selecting previously unselected package python-libcloud.
Preparing to unpack .../23-python-libcloud_2.2.1-1_all.deb ...
Unpacking python-libcloud (2.2.1-1) ...
Selecting previously unselected package python-openssl.
Preparing to unpack .../24-python-openssl_17.5.0-1ubuntu1_all.deb ...
Unpacking python-openssl (17.5.0-1ubuntu1) ...
Selecting previously unselected package python-selinux.
Preparing to unpack .../25-python-selinux_2.7-2build2_amd64.deb ...
Unpacking python-selinux (2.7-2build2) ...
Selecting previously unselected package python-xmltodict.
Preparing to unpack .../26-python-xmltodict_0.11.0-1_all.deb ...
Unpacking python-xmltodict (0.11.0-1) ...
Setting up python-idna (2.6-1) ...
Setting up python-simplejson (3.13.2-1) ...
Setting up python-urllib3 (1.22-1ubuntu0.18.04.2) ...
Setting up python-yaml (3.12-1build2) ...
Setting up python-asn1crypto (0.24.0-1) ...
Setting up python-chardet (3.0.4-1) ...
Setting up ieee-data (20180204.1) ...
Setting up python-pyasn1 (0.4.2-3) ...
Setting up python-netaddr (0.7.19-1) ...
Setting up python-xmltodict (0.11.0-1) ...
Setting up python-jmespath (0.9.3-1ubuntu1) ...
Setting up python-certifi (2018.1.18-2) ...
Setting up python-kerberos (1.1.14-1) ...
Setting up python-markupsafe (1.0-1build1) ...
Setting up python-httplib2 (0.9.2+dfsg-1ubuntu0.3) ...
Setting up python-cffi-backend (1.11.5-1) ...
Setting up python-selinux (2.7-2build2) ...
Setting up python-enum34 (1.1.6-2) ...
Setting up python-requests (2.18.4-2ubuntu0.1) ...
Setting up python-lockfile (1:0.12.2-2) ...
Setting up python-ipaddress (1.0.17-1) ...
Setting up python-jinja2 (2.10-1ubuntu0.18.04.1) ...
Setting up python-cryptography (2.1.4-1ubuntu1.4) ...
Setting up python-libcloud (2.2.1-1) ...
Setting up python-openssl (17.5.0-1ubuntu1) ...
Setting up python-paramiko (2.0.0-1ubuntu1.2) ...
Setting up ansible (2.5.1+dfsg-1ubuntu0.1) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
admatic@admaticmyVM:~$ ansible --version
ansible 2.5.1
  config file = /etc/ansible/ansible.cfg
  configured module search path = [u'/home/admatic/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python2.7/dist-packages/ansible
  executable location = /usr/bin/ansible
  python version = 2.7.17 (default, Feb 27 2021, 15:10:58) [GCC 7.5.0]
admatic@admaticmyVM:~$ 
admatic@admaticmyVM:~$ logout
Connection to 20.106.240.50 closed.
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ 
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ ls
ansible_install.sh  main.tf  robochef_stack.sh
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ vi ansible_install.sh 
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ 
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ vi main.tf 
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ vi main.tf 
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ cat main.tf 
provider "azurerm" {
	features {}
}

resource "azurerm_resource_group" "myterraformgroup" {
    name     = "myResourceGroup"
    location = "eastus"
}

resource "azurerm_virtual_network" "myterraformnetwork" {
	name = "myVnet"
	address_space = ["10.0.0.0/16"]
	location = "eastus"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
}

resource "azurerm_public_ip" "myterraformpublicip" {
    name                         = "myPublicIP"
    location                     = "eastus"
    resource_group_name          = azurerm_resource_group.myterraformgroup.name
    allocation_method            = "Dynamic"
}


resource "azurerm_subnet" "myterraformsubnet" {
	name = "mySubnet"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
	virtual_network_name = azurerm_virtual_network.myterraformnetwork.name
	address_prefixes = ["10.0.1.0/24"]
}

resource "azurerm_network_security_group" "myterraformnsg" {
    name                = "myNetworkSecurityGroup"
    location            = "eastus"
    resource_group_name = azurerm_resource_group.myterraformgroup.name

    security_rule {
        name                       = "Web"
        priority                   = 1001
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "Tcp"
        source_port_range          = "*"
        destination_port_range     = "22"
        source_address_prefix      = "*"
        destination_address_prefix = "*"
    }
}

resource "azurerm_network_interface" "myterraformnic" {
    name                      = "myNIC"
    location                  = "eastus"
    resource_group_name       = azurerm_resource_group.myterraformgroup.name

    ip_configuration {
        name                          = "myNicConfiguration"
        subnet_id                     = azurerm_subnet.myterraformsubnet.id
        private_ip_address_allocation = "Dynamic"
        public_ip_address_id          = azurerm_public_ip.myterraformpublicip.id
    }
}


resource "azurerm_network_interface_security_group_association" "example" {
    network_interface_id      = azurerm_network_interface.myterraformnic.id
    network_security_group_id = azurerm_network_security_group.myterraformnsg.id
}


resource "azurerm_linux_virtual_machine" "myterraformvm" {
    name                  = "admaticmyVM"
    location              = "eastus"
    resource_group_name   = azurerm_resource_group.myterraformgroup.name
    network_interface_ids = [azurerm_network_interface.myterraformnic.id]
    #size                  = "Standard_DS1_v2"
    size                  = "Standard_B1s"

    os_disk {
        name              = "myOsDisk"
        caching           = "ReadWrite"
        storage_account_type = "Premium_LRS"
    }

    source_image_reference {
        publisher = "Canonical"
        offer     = "UbuntuServer"
        sku       = "18.04-LTS"
        version   = "latest"
    }

    admin_username = "admatic"
    admin_password = "Sincere-Compete-Spoil-Private-3"
    disable_password_authentication = false
    

}

output "public_ip" {
  value = azurerm_public_ip.myterraformpublicip.ip_address
  description = "The public IP address of the vm"
}

resource "null_resource" "remote-provisioner" {
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "remote-exec" {
		inline = [
			"echo Remote Provisioner did this > /tmp/remoteexec.txt",
			"echo Remote Provisioner Completed first execution ",
			"sh /home/admatic/ansible_install.sh",
			"ls -l /tmp"
			]
	}
	depends_on = [null_resource.copy_script]

}

resource "null_resource" "copy_script" {
	
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "file" {
		source = "ansible_install.sh"
		destination = "/home/admatic/ansible_install.sh"
	}

}
saravanans@ubuntu:~/admatic_terraform_workspace/ansible_terraform_integration$ cd ../remoteexec_demo/
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ terraform destroy --auto-approve
azurerm_resource_group.myterraformgroup: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup]
azurerm_virtual_network.myterraformnetwork: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet]
azurerm_public_ip.myterraformpublicip: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP]
azurerm_network_security_group.myterraformnsg: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup]
null_resource.copy_script: Refreshing state... [id=5296749046347855248]
null_resource.remote-provisioner: Refreshing state... [id=5357297419012342329]
azurerm_subnet.myterraformsubnet: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet]
azurerm_network_interface.myterraformnic: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC]
azurerm_network_interface_security_group_association.example: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC|/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup]
azurerm_linux_virtual_machine.myterraformvm: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/admaticmyVM]

Terraform used the selected providers to generate the following execution plan. Resource actions are
indicated with the following symbols:
  - destroy

Terraform will perform the following actions:

  # azurerm_linux_virtual_machine.myterraformvm will be destroyed
  - resource "azurerm_linux_virtual_machine" "myterraformvm" {
      - admin_password                  = (sensitive value)
      - admin_username                  = "admatic" -> null
      - allow_extension_operations      = true -> null
      - computer_name                   = "admaticmyVM" -> null
      - disable_password_authentication = false -> null
      - encryption_at_host_enabled      = false -> null
      - extensions_time_budget          = "PT1H30M" -> null
      - id                              = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/admaticmyVM" -> null
      - location                        = "eastus" -> null
      - max_bid_price                   = -1 -> null
      - name                            = "admaticmyVM" -> null
      - network_interface_ids           = [
          - "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC",
        ] -> null
      - platform_fault_domain           = -1 -> null
      - priority                        = "Regular" -> null
      - private_ip_address              = "10.0.1.4" -> null
      - private_ip_addresses            = [
          - "10.0.1.4",
        ] -> null
      - provision_vm_agent              = true -> null
      - public_ip_address               = "20.106.240.50" -> null
      - public_ip_addresses             = [
          - "20.106.240.50",
        ] -> null
      - resource_group_name             = "myResourceGroup" -> null
      - size                            = "Standard_B1s" -> null
      - tags                            = {} -> null
      - virtual_machine_id              = "86ef383f-7eaf-4759-bd10-0511c1aaea71" -> null

      - os_disk {
          - caching                   = "ReadWrite" -> null
          - disk_size_gb              = 30 -> null
          - name                      = "myOsDisk" -> null
          - storage_account_type      = "Premium_LRS" -> null
          - write_accelerator_enabled = false -> null
        }

      - source_image_reference {
          - offer     = "UbuntuServer" -> null
          - publisher = "Canonical" -> null
          - sku       = "18.04-LTS" -> null
          - version   = "latest" -> null
        }
    }

  # azurerm_network_interface.myterraformnic will be destroyed
  - resource "azurerm_network_interface" "myterraformnic" {
      - applied_dns_servers           = [] -> null
      - dns_servers                   = [] -> null
      - enable_accelerated_networking = false -> null
      - enable_ip_forwarding          = false -> null
      - id                            = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC" -> null
      - internal_domain_name_suffix   = "x2wk30vh5yde1ewdn24tvr043h.bx.internal.cloudapp.net" -> null
      - location                      = "eastus" -> null
      - mac_address                   = "00-0D-3A-9C-F8-65" -> null
      - name                          = "myNIC" -> null
      - private_ip_address            = "10.0.1.4" -> null
      - private_ip_addresses          = [
          - "10.0.1.4",
        ] -> null
      - resource_group_name           = "myResourceGroup" -> null
      - tags                          = {} -> null
      - virtual_machine_id            = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/admaticmyVM" -> null

      - ip_configuration {
          - name                          = "myNicConfiguration" -> null
          - primary                       = true -> null
          - private_ip_address            = "10.0.1.4" -> null
          - private_ip_address_allocation = "Dynamic" -> null
          - private_ip_address_version    = "IPv4" -> null
          - public_ip_address_id          = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP" -> null
          - subnet_id                     = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet" -> null
        }
    }

  # azurerm_network_interface_security_group_association.example will be destroyed
  - resource "azurerm_network_interface_security_group_association" "example" {
      - id                        = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC|/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup" -> null
      - network_interface_id      = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC" -> null
      - network_security_group_id = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup" -> null
    }

  # azurerm_network_security_group.myterraformnsg will be destroyed
  - resource "azurerm_network_security_group" "myterraformnsg" {
      - id                  = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup" -> null
      - location            = "eastus" -> null
      - name                = "myNetworkSecurityGroup" -> null
      - resource_group_name = "myResourceGroup" -> null
      - security_rule       = [
          - {
              - access                                     = "Allow"
              - description                                = ""
              - destination_address_prefix                 = "*"
              - destination_address_prefixes               = []
              - destination_application_security_group_ids = []
              - destination_port_range                     = "22"
              - destination_port_ranges                    = []
              - direction                                  = "Inbound"
              - name                                       = "Web"
              - priority                                   = 1001
              - protocol                                   = "Tcp"
              - source_address_prefix                      = "*"
              - source_address_prefixes                    = []
              - source_application_security_group_ids      = []
              - source_port_range                          = "*"
              - source_port_ranges                         = []
            },
        ] -> null
      - tags                = {} -> null
    }

  # azurerm_public_ip.myterraformpublicip will be destroyed
  - resource "azurerm_public_ip" "myterraformpublicip" {
      - allocation_method       = "Dynamic" -> null
      - availability_zone       = "No-Zone" -> null
      - id                      = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP" -> null
      - idle_timeout_in_minutes = 4 -> null
      - ip_address              = "20.106.240.50" -> null
      - ip_tags                 = {} -> null
      - ip_version              = "IPv4" -> null
      - location                = "eastus" -> null
      - name                    = "myPublicIP" -> null
      - resource_group_name     = "myResourceGroup" -> null
      - sku                     = "Basic" -> null
      - sku_tier                = "Regional" -> null
      - tags                    = {} -> null
      - zones                   = [] -> null
    }

  # azurerm_resource_group.myterraformgroup will be destroyed
  - resource "azurerm_resource_group" "myterraformgroup" {
      - id       = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup" -> null
      - location = "eastus" -> null
      - name     = "myResourceGroup" -> null
      - tags     = {} -> null
    }

  # azurerm_subnet.myterraformsubnet will be destroyed
  - resource "azurerm_subnet" "myterraformsubnet" {
      - address_prefix                                 = "10.0.1.0/24" -> null
      - address_prefixes                               = [
          - "10.0.1.0/24",
        ] -> null
      - enforce_private_link_endpoint_network_policies = false -> null
      - enforce_private_link_service_network_policies  = false -> null
      - id                                             = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet" -> null
      - name                                           = "mySubnet" -> null
      - resource_group_name                            = "myResourceGroup" -> null
      - service_endpoint_policy_ids                    = [] -> null
      - service_endpoints                              = [] -> null
      - virtual_network_name                           = "myVnet" -> null
    }

  # azurerm_virtual_network.myterraformnetwork will be destroyed
  - resource "azurerm_virtual_network" "myterraformnetwork" {
      - address_space         = [
          - "10.0.0.0/16",
        ] -> null
      - dns_servers           = [] -> null
      - guid                  = "eaae2cbf-fea7-4d06-92c3-6f3d3ac75eef" -> null
      - id                    = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet" -> null
      - location              = "eastus" -> null
      - name                  = "myVnet" -> null
      - resource_group_name   = "myResourceGroup" -> null
      - subnet                = [
          - {
              - address_prefix = "10.0.1.0/24"
              - id             = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet"
              - name           = "mySubnet"
              - security_group = ""
            },
        ] -> null
      - tags                  = {} -> null
      - vm_protection_enabled = false -> null
    }

  # null_resource.copy_script will be destroyed
  - resource "null_resource" "copy_script" {
      - id       = "5296749046347855248" -> null
      - triggers = {
          - "trigger" = "2021-10-11T06:13:06Z"
        } -> null
    }

  # null_resource.remote-provisioner will be destroyed
  - resource "null_resource" "remote-provisioner" {
      - id       = "5357297419012342329" -> null
      - triggers = {
          - "trigger" = "2021-10-11T06:13:10Z"
        } -> null
    }

Plan: 0 to add, 0 to change, 10 to destroy.

Changes to Outputs:
  - public_ip = "20.106.240.50" -> null
null_resource.remote-provisioner: Destroying... [id=5357297419012342329]
null_resource.remote-provisioner: Destruction complete after 0s
null_resource.copy_script: Destroying... [id=5296749046347855248]
null_resource.copy_script: Destruction complete after 0s
azurerm_network_interface_security_group_association.example: Destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC|/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup]
azurerm_linux_virtual_machine.myterraformvm: Destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/admaticmyVM]


azurerm_network_interface_security_group_association.example: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...kSecurityGroups/myNetworkSecurityGroup, 13s elapsed]
azurerm_linux_virtual_machine.myterraformvm: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...ft.Compute/virtualMachines/admaticmyVM, 13s elapsed]
azurerm_network_interface_security_group_association.example: Destruction complete after 17s
azurerm_network_security_group.myterraformnsg: Destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup]
azurerm_linux_virtual_machine.myterraformvm: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...ft.Compute/virtualMachines/admaticmyVM, 23s elapsed]
azurerm_network_security_group.myterraformnsg: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...kSecurityGroups/myNetworkSecurityGroup, 10s elapsed]
azurerm_network_security_group.myterraformnsg: Destruction complete after 12s
azurerm_linux_virtual_machine.myterraformvm: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...ft.Compute/virtualMachines/admaticmyVM, 33s elapsed]
azurerm_linux_virtual_machine.myterraformvm: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...ft.Compute/virtualMachines/admaticmyVM, 47s elapsed]
azurerm_linux_virtual_machine.myterraformvm: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...ft.Compute/virtualMachines/admaticmyVM, 57s elapsed]
azurerm_linux_virtual_machine.myterraformvm: Destruction complete after 58s
azurerm_network_interface.myterraformnic: Destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC]
azurerm_network_interface.myterraformnic: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...rosoft.Network/networkInterfaces/myNIC, 10s elapsed]
azurerm_network_interface.myterraformnic: Destruction complete after 12s
azurerm_public_ip.myterraformpublicip: Destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP]
azurerm_subnet.myterraformsubnet: Destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet]
azurerm_subnet.myterraformsubnet: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...irtualNetworks/myVnet/subnets/mySubnet, 14s elapsed]
azurerm_public_ip.myterraformpublicip: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...t.Network/publicIPAddresses/myPublicIP, 14s elapsed]
azurerm_subnet.myterraformsubnet: Destruction complete after 15s
azurerm_virtual_network.myterraformnetwork: Destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet]
azurerm_public_ip.myterraformpublicip: Destruction complete after 16s
azurerm_virtual_network.myterraformnetwork: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...crosoft.Network/virtualNetworks/myVnet, 10s elapsed]
azurerm_virtual_network.myterraformnetwork: Destruction complete after 12s
azurerm_resource_group.myterraformgroup: Destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup]
azurerm_resource_group.myterraformgroup: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...70619d6/resourceGroups/myResourceGroup, 10s elapsed]
azurerm_resource_group.myterraformgroup: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...70619d6/resourceGroups/myResourceGroup, 23s elapsed]
azurerm_resource_group.myterraformgroup: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...70619d6/resourceGroups/myResourceGroup, 33s elapsed]
azurerm_resource_group.myterraformgroup: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...70619d6/resourceGroups/myResourceGroup, 43s elapsed]
azurerm_resource_group.myterraformgroup: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...70619d6/resourceGroups/myResourceGroup, 57s elapsed]
azurerm_resource_group.myterraformgroup: Still destroying... [id=/subscriptions/17801c1a-831f-43c1-8d8a-...70619d6/resourceGroups/myResourceGroup, 1m7s elapsed]
azurerm_resource_group.myterraformgroup: Destruction complete after 1m14s

Destroy complete! Resources: 10 destroyed.
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ 
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ 
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ ls
main.tf  robochef_stack.sh  robochef_stack.txt  terraform.tfstate  terraform.tfstate.backup
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ mkdir files
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ cd files
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo/files$ ls
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo/files$ vi ansible-playbook.yaml
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo/files$ cat ansible-playbook.yaml
---
- hosts: localhost
  sudo: yes
  vars:
    motd_warning: 'RoboChef the worlds First fully automated Robbotic Kitchen'
  tasks:
    - name: setup a MOTD
      copy: dest=/etc/motd content={{ motd_warning }}


saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo/files$ cd ..
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ ls files/ansible-playbook.yaml 
files/ansible-playbook.yaml
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ vi main.tf 
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ cat main.tf
provider "azurerm" {
	features {}
}

resource "azurerm_resource_group" "myterraformgroup" {
    name     = "myResourceGroup"
    location = "eastus"
}

resource "azurerm_virtual_network" "myterraformnetwork" {
	name = "myVnet"
	address_space = ["10.0.0.0/16"]
	location = "eastus"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
}

resource "azurerm_public_ip" "myterraformpublicip" {
    name                         = "myPublicIP"
    location                     = "eastus"
    resource_group_name          = azurerm_resource_group.myterraformgroup.name
    allocation_method            = "Dynamic"
}


resource "azurerm_subnet" "myterraformsubnet" {
	name = "mySubnet"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
	virtual_network_name = azurerm_virtual_network.myterraformnetwork.name
	address_prefixes = ["10.0.1.0/24"]
}

resource "azurerm_network_security_group" "myterraformnsg" {
    name                = "myNetworkSecurityGroup"
    location            = "eastus"
    resource_group_name = azurerm_resource_group.myterraformgroup.name

    security_rule {
        name                       = "Web"
        priority                   = 1001
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "Tcp"
        source_port_range          = "*"
        destination_port_range     = "22"
        source_address_prefix      = "*"
        destination_address_prefix = "*"
    }
}

resource "azurerm_network_interface" "myterraformnic" {
    name                      = "myNIC"
    location                  = "eastus"
    resource_group_name       = azurerm_resource_group.myterraformgroup.name

    ip_configuration {
        name                          = "myNicConfiguration"
        subnet_id                     = azurerm_subnet.myterraformsubnet.id
        private_ip_address_allocation = "Dynamic"
        public_ip_address_id          = azurerm_public_ip.myterraformpublicip.id
    }
}


resource "azurerm_network_interface_security_group_association" "example" {
    network_interface_id      = azurerm_network_interface.myterraformnic.id
    network_security_group_id = azurerm_network_security_group.myterraformnsg.id
}


resource "azurerm_linux_virtual_machine" "myterraformvm" {
    name                  = "admaticmyVM"
    location              = "eastus"
    resource_group_name   = azurerm_resource_group.myterraformgroup.name
    network_interface_ids = [azurerm_network_interface.myterraformnic.id]
    #size                  = "Standard_DS1_v2"
    size                  = "Standard_B1s"

    os_disk {
        name              = "myOsDisk"
        caching           = "ReadWrite"
        storage_account_type = "Premium_LRS"
    }

    source_image_reference {
        publisher = "Canonical"
        offer     = "UbuntuServer"
        sku       = "18.04-LTS"
        version   = "latest"
    }

    admin_username = "admatic"
    admin_password = "Sincere-Compete-Spoil-Private-3"
    disable_password_authentication = false
    

}

output "public_ip" {
  value = azurerm_public_ip.myterraformpublicip.ip_address
  description = "The public IP address of the vm"
}

resource "null_resource" "remote-provisioner" {
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "remote-exec" {
		inline = [
			"echo Remote Provisioner did this > /tmp/remoteexec.txt",
			"echo Remote Provisioner Completed first execution ",
			"sh /home/admatic/robochef_stack.sh",
			"ls -l /tmp"
			]
	}
	depends_on = [null_resource.copy_script,null_resource.copy_playbook]

}

resource "null_resource" "copy_script" {
	
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "file" {
		source = "robochef_stack.sh"
		destination = "/home/admatic/robochef_stack.sh"
	}

}

resource "null_resource" "copy_playbook" {

        triggers = {
                trigger = timestamp()

        }
        connection {
                type = "ssh"
                host = azurerm_public_ip.myterraformpublicip.ip_address
                user = "admatic"
                password ="Sincere-Compete-Spoil-Private-3"
                port = 22
                agent = true

        }
        provisioner "file" {
                source = "ansible-playbook.yaml"
                destination = "/home/admatic/ansible-playbook.yaml"
        }

}


saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ vi main.tf 
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ cat main.tf
provider "azurerm" {
	features {}
}

resource "azurerm_resource_group" "myterraformgroup" {
    name     = "myResourceGroup"
    location = "eastus"
}

resource "azurerm_virtual_network" "myterraformnetwork" {
	name = "myVnet"
	address_space = ["10.0.0.0/16"]
	location = "eastus"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
}

resource "azurerm_public_ip" "myterraformpublicip" {
    name                         = "myPublicIP"
    location                     = "eastus"
    resource_group_name          = azurerm_resource_group.myterraformgroup.name
    allocation_method            = "Dynamic"
}


resource "azurerm_subnet" "myterraformsubnet" {
	name = "mySubnet"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
	virtual_network_name = azurerm_virtual_network.myterraformnetwork.name
	address_prefixes = ["10.0.1.0/24"]
}

resource "azurerm_network_security_group" "myterraformnsg" {
    name                = "myNetworkSecurityGroup"
    location            = "eastus"
    resource_group_name = azurerm_resource_group.myterraformgroup.name

    security_rule {
        name                       = "Web"
        priority                   = 1001
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "Tcp"
        source_port_range          = "*"
        destination_port_range     = "22"
        source_address_prefix      = "*"
        destination_address_prefix = "*"
    }
}

resource "azurerm_network_interface" "myterraformnic" {
    name                      = "myNIC"
    location                  = "eastus"
    resource_group_name       = azurerm_resource_group.myterraformgroup.name

    ip_configuration {
        name                          = "myNicConfiguration"
        subnet_id                     = azurerm_subnet.myterraformsubnet.id
        private_ip_address_allocation = "Dynamic"
        public_ip_address_id          = azurerm_public_ip.myterraformpublicip.id
    }
}


resource "azurerm_network_interface_security_group_association" "example" {
    network_interface_id      = azurerm_network_interface.myterraformnic.id
    network_security_group_id = azurerm_network_security_group.myterraformnsg.id
}


resource "azurerm_linux_virtual_machine" "myterraformvm" {
    name                  = "admaticmyVM"
    location              = "eastus"
    resource_group_name   = azurerm_resource_group.myterraformgroup.name
    network_interface_ids = [azurerm_network_interface.myterraformnic.id]
    #size                  = "Standard_DS1_v2"
    size                  = "Standard_B1s"

    os_disk {
        name              = "myOsDisk"
        caching           = "ReadWrite"
        storage_account_type = "Premium_LRS"
    }

    source_image_reference {
        publisher = "Canonical"
        offer     = "UbuntuServer"
        sku       = "18.04-LTS"
        version   = "latest"
    }

    admin_username = "admatic"
    admin_password = "Sincere-Compete-Spoil-Private-3"
    disable_password_authentication = false
    

}

output "public_ip" {
  value = azurerm_public_ip.myterraformpublicip.ip_address
  description = "The public IP address of the vm"
}

resource "null_resource" "remote-provisioner" {
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "remote-exec" {
		inline = [
			"echo Remote Provisioner did this > /tmp/remoteexec.txt",
			"echo Remote Provisioner Completed first execution ",
			"sh /home/admatic/robochef_stack.sh",
			"ls -l /tmp"
			]
	}
	depends_on = [null_resource.copy_script,null_resource.copy_playbook]

}

resource "null_resource" "copy_script" {
	
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "file" {
		source = "robochef_stack.sh"
		destination = "/home/admatic/robochef_stack.sh"
	}

}

resource "null_resource" "copy_playbook" {

        triggers = {
                trigger = timestamp()

        }
        connection {
                type = "ssh"
                host = azurerm_public_ip.myterraformpublicip.ip_address
                user = "admatic"
                password ="Sincere-Compete-Spoil-Private-3"
                port = 22
                agent = true

        }
        provisioner "file" {
                source = "files/ansible-playbook.yaml"
                destination = "/home/admatic/ansible-playbook.yaml"
        }

}


saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ ls files/ansible-playbook.yaml
files/ansible-playbook.yaml
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ cat files/ansible-playbook.yaml
---
- hosts: localhost
  sudo: yes
  vars:
    motd_warning: 'RoboChef the worlds First fully automated Robbotic Kitchen'
  tasks:
    - name: setup a MOTD
      copy: dest=/etc/motd content={{ motd_warning }}


saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ vi main.tf 
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ ls
files  main.tf  robochef_stack.sh  robochef_stack.txt  terraform.tfstate  terraform.tfstate.backup
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ vi main.tf 
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ cat main.tf
provider "azurerm" {
	features {}
}

resource "azurerm_resource_group" "myterraformgroup" {
    name     = "myResourceGroup"
    location = "eastus"
}

resource "azurerm_virtual_network" "myterraformnetwork" {
	name = "myVnet"
	address_space = ["10.0.0.0/16"]
	location = "eastus"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
}

resource "azurerm_public_ip" "myterraformpublicip" {
    name                         = "myPublicIP"
    location                     = "eastus"
    resource_group_name          = azurerm_resource_group.myterraformgroup.name
    allocation_method            = "Dynamic"
}


resource "azurerm_subnet" "myterraformsubnet" {
	name = "mySubnet"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
	virtual_network_name = azurerm_virtual_network.myterraformnetwork.name
	address_prefixes = ["10.0.1.0/24"]
}

resource "azurerm_network_security_group" "myterraformnsg" {
    name                = "myNetworkSecurityGroup"
    location            = "eastus"
    resource_group_name = azurerm_resource_group.myterraformgroup.name

    security_rule {
        name                       = "Web"
        priority                   = 1001
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "Tcp"
        source_port_range          = "*"
        destination_port_range     = "22"
        source_address_prefix      = "*"
        destination_address_prefix = "*"
    }
}

resource "azurerm_network_interface" "myterraformnic" {
    name                      = "myNIC"
    location                  = "eastus"
    resource_group_name       = azurerm_resource_group.myterraformgroup.name

    ip_configuration {
        name                          = "myNicConfiguration"
        subnet_id                     = azurerm_subnet.myterraformsubnet.id
        private_ip_address_allocation = "Dynamic"
        public_ip_address_id          = azurerm_public_ip.myterraformpublicip.id
    }
}


resource "azurerm_network_interface_security_group_association" "example" {
    network_interface_id      = azurerm_network_interface.myterraformnic.id
    network_security_group_id = azurerm_network_security_group.myterraformnsg.id
}


resource "azurerm_linux_virtual_machine" "myterraformvm" {
    name                  = "admaticmyVM"
    location              = "eastus"
    resource_group_name   = azurerm_resource_group.myterraformgroup.name
    network_interface_ids = [azurerm_network_interface.myterraformnic.id]
    #size                  = "Standard_DS1_v2"
    size                  = "Standard_B1s"

    os_disk {
        name              = "myOsDisk"
        caching           = "ReadWrite"
        storage_account_type = "Premium_LRS"
    }

    source_image_reference {
        publisher = "Canonical"
        offer     = "UbuntuServer"
        sku       = "18.04-LTS"
        version   = "latest"
    }

    admin_username = "admatic"
    admin_password = "Sincere-Compete-Spoil-Private-3"
    disable_password_authentication = false
    

}

output "public_ip" {
  value = azurerm_public_ip.myterraformpublicip.ip_address
  description = "The public IP address of the vm"
}

resource "null_resource" "remote-provisioner" {
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "remote-exec" {
		inline = [
			"echo Remote Provisioner did this > /tmp/remoteexec.txt",
			"echo Remote Provisioner Completed first execution ",
			"sh /home/admatic/robochef_stack.sh",
			"ls -l /tmp",
			"cd /home/admatic && ansible-playbook admatic-playook.yaml"
			]
	}
	depends_on = [null_resource.copy_script,null_resource.copy_playbook]

}

resource "null_resource" "copy_script" {
	
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "file" {
		source = "robochef_stack.sh"
		destination = "/home/admatic/robochef_stack.sh"
	}

}

resource "null_resource" "copy_playbook" {

        triggers = {
                trigger = timestamp()

        }
        connection {
                type = "ssh"
                host = azurerm_public_ip.myterraformpublicip.ip_address
                user = "admatic"
                password ="Sincere-Compete-Spoil-Private-3"
                port = 22
                agent = true

        }
        provisioner "file" {
                source = "files/ansible-playbook.yaml"
                destination = "/home/admatic/ansible-playbook.yaml"
        }

}


saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ terraform init

Initializing the backend...

Initializing provider plugins...
- Reusing previous version of hashicorp/null from the dependency lock file
- Reusing previous version of hashicorp/azurerm from the dependency lock file
- Using previously-installed hashicorp/null v3.1.0
- Using previously-installed hashicorp/azurerm v2.80.0

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ terraform apply --auto-approve

Terraform used the selected providers to generate the following execution plan. Resource actions are
indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # azurerm_linux_virtual_machine.myterraformvm will be created
  + resource "azurerm_linux_virtual_machine" "myterraformvm" {
      + admin_password                  = (sensitive value)
      + admin_username                  = "admatic"
      + allow_extension_operations      = true
      + computer_name                   = (known after apply)
      + disable_password_authentication = false
      + extensions_time_budget          = "PT1H30M"
      + id                              = (known after apply)
      + location                        = "eastus"
      + max_bid_price                   = -1
      + name                            = "admaticmyVM"
      + network_interface_ids           = (known after apply)
      + platform_fault_domain           = -1
      + priority                        = "Regular"
      + private_ip_address              = (known after apply)
      + private_ip_addresses            = (known after apply)
      + provision_vm_agent              = true
      + public_ip_address               = (known after apply)
      + public_ip_addresses             = (known after apply)
      + resource_group_name             = "myResourceGroup"
      + size                            = "Standard_B1s"
      + virtual_machine_id              = (known after apply)
      + zone                            = (known after apply)

      + os_disk {
          + caching                   = "ReadWrite"
          + disk_size_gb              = (known after apply)
          + name                      = "myOsDisk"
          + storage_account_type      = "Premium_LRS"
          + write_accelerator_enabled = false
        }

      + source_image_reference {
          + offer     = "UbuntuServer"
          + publisher = "Canonical"
          + sku       = "18.04-LTS"
          + version   = "latest"
        }
    }

  # azurerm_network_interface.myterraformnic will be created
  + resource "azurerm_network_interface" "myterraformnic" {
      + applied_dns_servers           = (known after apply)
      + dns_servers                   = (known after apply)
      + enable_accelerated_networking = false
      + enable_ip_forwarding          = false
      + id                            = (known after apply)
      + internal_dns_name_label       = (known after apply)
      + internal_domain_name_suffix   = (known after apply)
      + location                      = "eastus"
      + mac_address                   = (known after apply)
      + name                          = "myNIC"
      + private_ip_address            = (known after apply)
      + private_ip_addresses          = (known after apply)
      + resource_group_name           = "myResourceGroup"
      + virtual_machine_id            = (known after apply)

      + ip_configuration {
          + name                          = "myNicConfiguration"
          + primary                       = (known after apply)
          + private_ip_address            = (known after apply)
          + private_ip_address_allocation = "dynamic"
          + private_ip_address_version    = "IPv4"
          + public_ip_address_id          = (known after apply)
          + subnet_id                     = (known after apply)
        }
    }

  # azurerm_network_interface_security_group_association.example will be created
  + resource "azurerm_network_interface_security_group_association" "example" {
      + id                        = (known after apply)
      + network_interface_id      = (known after apply)
      + network_security_group_id = (known after apply)
    }

  # azurerm_network_security_group.myterraformnsg will be created
  + resource "azurerm_network_security_group" "myterraformnsg" {
      + id                  = (known after apply)
      + location            = "eastus"
      + name                = "myNetworkSecurityGroup"
      + resource_group_name = "myResourceGroup"
      + security_rule       = [
          + {
              + access                                     = "Allow"
              + description                                = ""
              + destination_address_prefix                 = "*"
              + destination_address_prefixes               = []
              + destination_application_security_group_ids = []
              + destination_port_range                     = "22"
              + destination_port_ranges                    = []
              + direction                                  = "Inbound"
              + name                                       = "Web"
              + priority                                   = 1001
              + protocol                                   = "Tcp"
              + source_address_prefix                      = "*"
              + source_address_prefixes                    = []
              + source_application_security_group_ids      = []
              + source_port_range                          = "*"
              + source_port_ranges                         = []
            },
        ]
    }

  # azurerm_public_ip.myterraformpublicip will be created
  + resource "azurerm_public_ip" "myterraformpublicip" {
      + allocation_method       = "Dynamic"
      + availability_zone       = (known after apply)
      + fqdn                    = (known after apply)
      + id                      = (known after apply)
      + idle_timeout_in_minutes = 4
      + ip_address              = (known after apply)
      + ip_version              = "IPv4"
      + location                = "eastus"
      + name                    = "myPublicIP"
      + resource_group_name     = "myResourceGroup"
      + sku                     = "Basic"
      + sku_tier                = "Regional"
      + zones                   = (known after apply)
    }

  # azurerm_resource_group.myterraformgroup will be created
  + resource "azurerm_resource_group" "myterraformgroup" {
      + id       = (known after apply)
      + location = "eastus"
      + name     = "myResourceGroup"
    }

  # azurerm_subnet.myterraformsubnet will be created
  + resource "azurerm_subnet" "myterraformsubnet" {
      + address_prefix                                 = (known after apply)
      + address_prefixes                               = [
          + "10.0.1.0/24",
        ]
      + enforce_private_link_endpoint_network_policies = false
      + enforce_private_link_service_network_policies  = false
      + id                                             = (known after apply)
      + name                                           = "mySubnet"
      + resource_group_name                            = "myResourceGroup"
      + virtual_network_name                           = "myVnet"
    }

  # azurerm_virtual_network.myterraformnetwork will be created
  + resource "azurerm_virtual_network" "myterraformnetwork" {
      + address_space         = [
          + "10.0.0.0/16",
        ]
      + dns_servers           = (known after apply)
      + guid                  = (known after apply)
      + id                    = (known after apply)
      + location              = "eastus"
      + name                  = "myVnet"
      + resource_group_name   = "myResourceGroup"
      + subnet                = (known after apply)
      + vm_protection_enabled = false
    }

  # null_resource.copy_playbook will be created
  + resource "null_resource" "copy_playbook" {
      + id       = (known after apply)
      + triggers = (known after apply)
    }

  # null_resource.copy_script will be created
  + resource "null_resource" "copy_script" {
      + id       = (known after apply)
      + triggers = (known after apply)
    }

  # null_resource.remote-provisioner will be created
  + resource "null_resource" "remote-provisioner" {
      + id       = (known after apply)
      + triggers = (known after apply)
    }

Plan: 11 to add, 0 to change, 0 to destroy.

Changes to Outputs:
  + public_ip = (known after apply)
azurerm_resource_group.myterraformgroup: Creating...
azurerm_resource_group.myterraformgroup: Creation complete after 3s [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup]
azurerm_public_ip.myterraformpublicip: Creating...
azurerm_virtual_network.myterraformnetwork: Creating...
azurerm_network_security_group.myterraformnsg: Creating...
azurerm_public_ip.myterraformpublicip: Creation complete after 8s [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP]
null_resource.copy_script: Creating...
null_resource.copy_playbook: Creating...
null_resource.copy_playbook: Provisioning with 'file'...
null_resource.copy_script: Provisioning with 'file'...
azurerm_virtual_network.myterraformnetwork: Still creating... [10s elapsed]
azurerm_network_security_group.myterraformnsg: Still creating... [10s elapsed]
azurerm_virtual_network.myterraformnetwork: Creation complete after 11s [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet]
azurerm_subnet.myterraformsubnet: Creating...
azurerm_network_security_group.myterraformnsg: Creation complete after 11s [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup]
azurerm_subnet.myterraformsubnet: Creation complete after 11s [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet]
azurerm_network_interface.myterraformnic: Creating...
azurerm_network_interface.myterraformnic: Creation complete after 6s [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC]
azurerm_network_interface_security_group_association.example: Creating...
azurerm_linux_virtual_machine.myterraformvm: Creating...
azurerm_network_interface_security_group_association.example: Creation complete after 4s [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC|/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup]
azurerm_linux_virtual_machine.myterraformvm: Still creating... [11s elapsed]
azurerm_linux_virtual_machine.myterraformvm: Still creating... [21s elapsed]
azurerm_linux_virtual_machine.myterraformvm: Still creating... [34s elapsed]
azurerm_linux_virtual_machine.myterraformvm: Still creating... [44s elapsed]
azurerm_linux_virtual_machine.myterraformvm: Still creating... [54s elapsed]
azurerm_linux_virtual_machine.myterraformvm: Still creating... [1m4s elapsed]
azurerm_linux_virtual_machine.myterraformvm: Still creating... [1m14s elapsed]
azurerm_linux_virtual_machine.myterraformvm: Still creating... [1m24s elapsed]
azurerm_linux_virtual_machine.myterraformvm: Still creating... [1m41s elapsed]
azurerm_linux_virtual_machine.myterraformvm: Still creating... [1m51s elapsed]
azurerm_linux_virtual_machine.myterraformvm: Creation complete after 1m57s [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/admaticmyVM]
╷
│ Error: file provisioner error
│ 
│   with null_resource.copy_script,
│   on main.tf line 145, in resource "null_resource" "copy_script":
│  145: 	provisioner "file" {
│ 
│ host for provisioner cannot be empty
╵
╷
│ Error: file provisioner error
│ 
│   with null_resource.copy_playbook,
│   on main.tf line 167, in resource "null_resource" "copy_playbook":
│  167:         provisioner "file" {
│ 
│ host for provisioner cannot be empty
╵
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ vi main.tf 
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ terraform apply --auto-approve
azurerm_resource_group.myterraformgroup: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup]
azurerm_network_security_group.myterraformnsg: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup]
azurerm_public_ip.myterraformpublicip: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP]
azurerm_virtual_network.myterraformnetwork: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet]
null_resource.copy_script: Refreshing state... [id=6359474422987977577]
null_resource.copy_playbook: Refreshing state... [id=216800195248356585]
azurerm_subnet.myterraformsubnet: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet]
azurerm_network_interface.myterraformnic: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC]
azurerm_network_interface_security_group_association.example: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC|/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup]
azurerm_linux_virtual_machine.myterraformvm: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/admaticmyVM]

Note: Objects have changed outside of Terraform

Terraform detected the following changes made outside of Terraform since the last "terraform apply":

  # azurerm_network_interface.myterraformnic has been changed
  ~ resource "azurerm_network_interface" "myterraformnic" {
        id                            = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC"
      + mac_address                   = "00-22-48-28-90-D6"
        name                          = "myNIC"
      + tags                          = {}
      + virtual_machine_id            = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/admaticmyVM"
        # (9 unchanged attributes hidden)

        # (1 unchanged block hidden)
    }
  # azurerm_linux_virtual_machine.myterraformvm has been changed
  ~ resource "azurerm_linux_virtual_machine" "myterraformvm" {
        id                              = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/admaticmyVM"
        name                            = "admaticmyVM"
      + tags                            = {}
        # (20 unchanged attributes hidden)


        # (2 unchanged blocks hidden)
    }
  # azurerm_virtual_network.myterraformnetwork has been changed
  ~ resource "azurerm_virtual_network" "myterraformnetwork" {
        id                    = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet"
        name                  = "myVnet"
      ~ subnet                = [
          + {
              + address_prefix = "10.0.1.0/24"
              + id             = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet"
              + name           = "mySubnet"
              + security_group = ""
            },
        ]
      + tags                  = {}
        # (6 unchanged attributes hidden)
    }
  # azurerm_subnet.myterraformsubnet has been changed
  ~ resource "azurerm_subnet" "myterraformsubnet" {
        id                                             = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet"
        name                                           = "mySubnet"
      + service_endpoint_policy_ids                    = []
      + service_endpoints                              = []
        # (6 unchanged attributes hidden)
    }
  # azurerm_network_security_group.myterraformnsg has been changed
  ~ resource "azurerm_network_security_group" "myterraformnsg" {
        id                  = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup"
        name                = "myNetworkSecurityGroup"
      + tags                = {}
        # (3 unchanged attributes hidden)
    }
  # azurerm_resource_group.myterraformgroup has been changed
  ~ resource "azurerm_resource_group" "myterraformgroup" {
        id       = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup"
        name     = "myResourceGroup"
      + tags     = {}
        # (1 unchanged attribute hidden)
    }
  # azurerm_public_ip.myterraformpublicip has been changed
  ~ resource "azurerm_public_ip" "myterraformpublicip" {
        id                      = "/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP"
      + ip_address              = "13.68.144.196"
      + ip_tags                 = {}
        name                    = "myPublicIP"
      + tags                    = {}
        # (9 unchanged attributes hidden)
    }

Unless you have made equivalent changes to your configuration, or ignored the relevant attributes using
ignore_changes, the following plan may include actions to undo or respond to these changes.

─────────────────────────────────────────────────────────────────────────────────────────────────────────

Terraform used the selected providers to generate the following execution plan. Resource actions are
indicated with the following symbols:
  + create
-/+ destroy and then create replacement

Terraform will perform the following actions:

  # null_resource.copy_playbook is tainted, so must be replaced
-/+ resource "null_resource" "copy_playbook" {
      ~ id       = "216800195248356585" -> (known after apply)
      ~ triggers = {
          - "trigger" = "2021-10-11T07:02:31Z"
        } -> (known after apply)
    }

  # null_resource.copy_script is tainted, so must be replaced
-/+ resource "null_resource" "copy_script" {
      ~ id       = "6359474422987977577" -> (known after apply)
      ~ triggers = {
          - "trigger" = "2021-10-11T07:02:31Z"
        } -> (known after apply)
    }

  # null_resource.remote-provisioner will be created
  + resource "null_resource" "remote-provisioner" {
      + id       = (known after apply)
      + triggers = (known after apply)
    }

Plan: 3 to add, 0 to change, 2 to destroy.

Changes to Outputs:
  + public_ip = "13.68.144.196"


saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ vi main.tf 
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ cat main.tf
provider "azurerm" {
	features {}
}

resource "azurerm_resource_group" "myterraformgroup" {
    name     = "myResourceGroup"
    location = "eastus"
}

resource "azurerm_virtual_network" "myterraformnetwork" {
	name = "myVnet"
	address_space = ["10.0.0.0/16"]
	location = "eastus"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
}

resource "azurerm_public_ip" "myterraformpublicip" {
    name                         = "myPublicIP"
    location                     = "eastus"
    resource_group_name          = azurerm_resource_group.myterraformgroup.name
    allocation_method            = "Dynamic"
}


resource "azurerm_subnet" "myterraformsubnet" {
	name = "mySubnet"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
	virtual_network_name = azurerm_virtual_network.myterraformnetwork.name
	address_prefixes = ["10.0.1.0/24"]
}

resource "azurerm_network_security_group" "myterraformnsg" {
    name                = "myNetworkSecurityGroup"
    location            = "eastus"
    resource_group_name = azurerm_resource_group.myterraformgroup.name

    security_rule {
        name                       = "Web"
        priority                   = 1001
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "Tcp"
        source_port_range          = "*"
        destination_port_range     = "22"
        source_address_prefix      = "*"
        destination_address_prefix = "*"
    }
}

resource "azurerm_network_interface" "myterraformnic" {
    name                      = "myNIC"
    location                  = "eastus"
    resource_group_name       = azurerm_resource_group.myterraformgroup.name

    ip_configuration {
        name                          = "myNicConfiguration"
        subnet_id                     = azurerm_subnet.myterraformsubnet.id
        private_ip_address_allocation = "Dynamic"
        public_ip_address_id          = azurerm_public_ip.myterraformpublicip.id
    }
}


resource "azurerm_network_interface_security_group_association" "example" {
    network_interface_id      = azurerm_network_interface.myterraformnic.id
    network_security_group_id = azurerm_network_security_group.myterraformnsg.id
}


resource "azurerm_linux_virtual_machine" "myterraformvm" {
    name                  = "admaticmyVM"
    location              = "eastus"
    resource_group_name   = azurerm_resource_group.myterraformgroup.name
    network_interface_ids = [azurerm_network_interface.myterraformnic.id]
    #size                  = "Standard_DS1_v2"
    size                  = "Standard_B1s"

    os_disk {
        name              = "myOsDisk"
        caching           = "ReadWrite"
        storage_account_type = "Premium_LRS"
    }

    source_image_reference {
        publisher = "Canonical"
        offer     = "UbuntuServer"
        sku       = "18.04-LTS"
        version   = "latest"
    }

    admin_username = "admatic"
    admin_password = "Sincere-Compete-Spoil-Private-3"
    disable_password_authentication = false
    

}

output "public_ip" {
  value = azurerm_public_ip.myterraformpublicip.ip_address
  description = "The public IP address of the vm"
}

resource "null_resource" "remote-provisioner" {
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "remote-exec" {
		inline = [
			"echo Remote Provisioner did this > /tmp/remoteexec.txt",
			"echo Remote Provisioner Completed first execution ",
			"sh /home/admatic/robochef_stack.sh",
			"ls -l /tmp",
			"cd /home/admatic && ansible-playbook ansible-playbook.yaml"
			]
	}
	depends_on = [null_resource.copy_script,null_resource.copy_playbook]

}

resource "null_resource" "copy_script" {
	
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "file" {
		source = "robochef_stack.sh"
		destination = "/home/admatic/robochef_stack.sh"
	}

}

resource "null_resource" "copy_playbook" {

        triggers = {
                trigger = timestamp()

        }
        connection {
                type = "ssh"
                host = azurerm_public_ip.myterraformpublicip.ip_address
                user = "admatic"
                password ="Sincere-Compete-Spoil-Private-3"
                port = 22
                agent = true

        }
        provisioner "file" {
                source = "files/ansible-playbook.yaml"
                destination = "/home/admatic/ansible-playbook.yaml"
        }

}


saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ terraform apply --auto-approve
azurerm_resource_group.myterraformgroup: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup]
azurerm_public_ip.myterraformpublicip: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP]
azurerm_virtual_network.myterraformnetwork: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet]
azurerm_network_security_group.myterraformnsg: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup]
null_resource.copy_script: Refreshing state... [id=7734109882996970609]
null_resource.copy_playbook: Refreshing state... [id=2976871866840095410]
null_resource.remote-provisioner: Refreshing state... [id=4919103878804485300]
azurerm_subnet.myterraformsubnet: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet]
azurerm_network_interface.myterraformnic: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC]
azurerm_network_interface_security_group_association.example: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC|/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup]
azurerm_linux_virtual_machine.myterraformvm: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/admaticmyVM]

Terraform used the selected providers to generate the following execution plan. Resource actions are
indicated with the following symbols:
-/+ destroy and then create replacement

Terraform will perform the following actions:

  # null_resource.copy_playbook must be replaced
-/+ resource "null_resource" "copy_playbook" {
      ~ id       = "2976871866840095410" -> (known after apply)
      ~ triggers = {
          - "trigger" = "2021-10-11T07:09:36Z"
        } -> (known after apply) # forces replacement
    }

  # null_resource.copy_script must be replaced
-/+ resource "null_resource" "copy_script" {
      ~ id       = "7734109882996970609" -> (known after apply)
      ~ triggers = {
          - "trigger" = "2021-10-11T07:09:36Z"
        } -> (known after apply) # forces replacement
    }

  # null_resource.remote-provisioner is tainted, so must be replaced
-/+ resource "null_resource" "remote-provisioner" {
      ~ id       = "4919103878804485300" -> (known after apply)
      ~ triggers = {
          - "trigger" = "2021-10-11T07:09:41Z"
        } -> (known after apply)
    }

Plan: 3 to add, 0 to change, 3 to destroy.
null_resource.remote-provisioner: Destroying... [id=4919103878804485300]
null_resource.remote-provisioner: Destruction complete after 0s
null_resource.copy_script: Destroying... [id=7734109882996970609]
null_resource.copy_playbook: Destroying... [id=2976871866840095410]
null_resource.copy_playbook: Destruction complete after 0s
null_resource.copy_script: Destruction complete after 0s
null_resource.copy_playbook: Creating...
null_resource.copy_script: Creating...
null_resource.copy_script: Provisioning with 'file'...
null_resource.copy_playbook: Provisioning with 'file'...
null_resource.copy_script: Creation complete after 4s [id=7882599186433748529]
null_resource.copy_playbook: Creation complete after 4s [id=7032563699647622175]
null_resource.remote-provisioner: Creating...
null_resource.remote-provisioner: Provisioning with 'remote-exec'...
null_resource.remote-provisioner (remote-exec): Connecting to remote host via SSH...
null_resource.remote-provisioner (remote-exec):   Host: 13.68.144.196
null_resource.remote-provisioner (remote-exec):   User: admatic
null_resource.remote-provisioner (remote-exec):   Password: true
null_resource.remote-provisioner (remote-exec):   Private key: false
null_resource.remote-provisioner (remote-exec):   Certificate: false
null_resource.remote-provisioner (remote-exec):   SSH Agent: true
null_resource.remote-provisioner (remote-exec):   Checking Host Key: false
null_resource.remote-provisioner (remote-exec):   Target Platform: unix
null_resource.remote-provisioner (remote-exec): Connected!
null_resource.remote-provisioner (remote-exec): Remote Provisioner Completed first execution
null_resource.remote-provisioner (remote-exec): beginning the execution of robochef stack
null_resource.remote-provisioner (remote-exec): 
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): Hit:1 http://azure.archive.ubuntu.com/ubuntu bionic InRelease
null_resource.remote-provisioner (remote-exec): 
null_resource.remote-provisioner (remote-exec): 0% [Connecting to security.ubuntu.com (
null_resource.remote-provisioner (remote-exec): Hit:2 http://azure.archive.ubuntu.com/ubuntu bionic-updates InRelease
null_resource.remote-provisioner (remote-exec): Hit:3 http://azure.archive.ubuntu.com/ubuntu bionic-backports InRelease
null_resource.remote-provisioner (remote-exec): 
null_resource.remote-provisioner (remote-exec): 0% [Waiting for headers]
null_resource.remote-provisioner (remote-exec): 0% [1 InRelease gpgv 242 kB] [Waiting f
null_resource.remote-provisioner (remote-exec): Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease
null_resource.remote-provisioner (remote-exec): 
null_resource.remote-provisioner (remote-exec): 0% [1 InRelease gpgv 242 kB]
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): 0% [2 InRelease gpgv 88.7 kB]
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): 0% [3 InRelease gpgv 74.6 kB]
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): 0% [4 InRelease gpgv 88.7 kB]
null_resource.remote-provisioner (remote-exec): 20% [Working]
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 3%
null_resource.remote-provisioner (remote-exec): Reading package lists... 3%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 34%
null_resource.remote-provisioner (remote-exec): Reading package lists... 37%
null_resource.remote-provisioner (remote-exec): Reading package lists... 37%
null_resource.remote-provisioner (remote-exec): Reading package lists... 53%
null_resource.remote-provisioner (remote-exec): Reading package lists... 53%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 62%
null_resource.remote-provisioner (remote-exec): Reading package lists... 62%
null_resource.remote-provisioner (remote-exec): Reading package lists... 67%
null_resource.remote-provisioner (remote-exec): Reading package lists... 67%
null_resource.remote-provisioner (remote-exec): Reading package lists... 69%
null_resource.remote-provisioner (remote-exec): Reading package lists... 69%
null_resource.remote-provisioner (remote-exec): Reading package lists... 70%
null_resource.remote-provisioner (remote-exec): Reading package lists... 70%
null_resource.remote-provisioner (remote-exec): Reading package lists... 76%
null_resource.remote-provisioner (remote-exec): Reading package lists... 76%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 86%
null_resource.remote-provisioner (remote-exec): Reading package lists... 86%
null_resource.remote-provisioner (remote-exec): Reading package lists... 91%
null_resource.remote-provisioner (remote-exec): Reading package lists... 91%
null_resource.remote-provisioner (remote-exec): Reading package lists... 92%
null_resource.remote-provisioner (remote-exec): Reading package lists... 92%
null_resource.remote-provisioner (remote-exec): Reading package lists... 93%
null_resource.remote-provisioner (remote-exec): Reading package lists... 93%
null_resource.remote-provisioner (remote-exec): Reading package lists... 97%
null_resource.remote-provisioner (remote-exec): Reading package lists... 97%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... Done
null_resource.remote-provisioner (remote-exec): 8 packages can be upgraded. Run 'apt list --upgradable' to see them.
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 100%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... Done
null_resource.remote-provisioner (remote-exec): apache2 is already the newest version (2.4.29-1ubuntu4.19).
null_resource.remote-provisioner (remote-exec): The following package was automatically installed and is no longer required:
null_resource.remote-provisioner (remote-exec):   linux-headers-4.15.0-159
null_resource.remote-provisioner (remote-exec): Use 'sudo apt autoremove' to remove it.
null_resource.remote-provisioner (remote-exec): 0 upgraded, 0 newly installed, 0 to remove and 8 not upgraded.
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): Hit:1 http://azure.archive.ubuntu.com/ubuntu bionic InRelease
null_resource.remote-provisioner (remote-exec): 0% [Connecting to security.ubuntu.com (
null_resource.remote-provisioner (remote-exec): Hit:2 http://azure.archive.ubuntu.com/ubuntu bionic-updates InRelease
null_resource.remote-provisioner (remote-exec): Hit:3 http://azure.archive.ubuntu.com/ubuntu bionic-backports InRelease
null_resource.remote-provisioner (remote-exec): 0% [Waiting for headers]
null_resource.remote-provisioner (remote-exec): 0% [1 InRelease gpgv 242 kB] [Waiting f
null_resource.remote-provisioner (remote-exec): Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease
null_resource.remote-provisioner (remote-exec): 0% [1 InRelease gpgv 242 kB]
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): 0% [2 InRelease gpgv 88.7 kB]
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): 0% [3 InRelease gpgv 74.6 kB]
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): 0% [4 InRelease gpgv 88.7 kB]
null_resource.remote-provisioner (remote-exec): 20% [Working]
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 3%
null_resource.remote-provisioner (remote-exec): Reading package lists... 3%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 36%
null_resource.remote-provisioner (remote-exec): Reading package lists... 37%
null_resource.remote-provisioner (remote-exec): Reading package lists... 37%
null_resource.remote-provisioner (remote-exec): Reading package lists... 53%
null_resource.remote-provisioner (remote-exec): Reading package lists... 53%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner: Still creating... [10s elapsed]
null_resource.remote-provisioner (remote-exec): Reading package lists... 62%
null_resource.remote-provisioner (remote-exec): Reading package lists... 62%
null_resource.remote-provisioner (remote-exec): Reading package lists... 67%
null_resource.remote-provisioner (remote-exec): Reading package lists... 67%
null_resource.remote-provisioner (remote-exec): Reading package lists... 69%
null_resource.remote-provisioner (remote-exec): Reading package lists... 69%
null_resource.remote-provisioner (remote-exec): Reading package lists... 70%
null_resource.remote-provisioner (remote-exec): Reading package lists... 70%
null_resource.remote-provisioner (remote-exec): Reading package lists... 76%
null_resource.remote-provisioner (remote-exec): Reading package lists... 76%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 86%
null_resource.remote-provisioner (remote-exec): Reading package lists... 86%
null_resource.remote-provisioner (remote-exec): Reading package lists... 91%
null_resource.remote-provisioner (remote-exec): Reading package lists... 91%
null_resource.remote-provisioner (remote-exec): Reading package lists... 92%
null_resource.remote-provisioner (remote-exec): Reading package lists... 92%
null_resource.remote-provisioner (remote-exec): Reading package lists... 93%
null_resource.remote-provisioner (remote-exec): Reading package lists... 93%
null_resource.remote-provisioner (remote-exec): Reading package lists... 97%
null_resource.remote-provisioner (remote-exec): Reading package lists... 97%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 100%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... Done
null_resource.remote-provisioner (remote-exec): software-properties-common is already the newest version (0.96.24.32.14).
null_resource.remote-provisioner (remote-exec): The following package was automatically installed and is no longer required:
null_resource.remote-provisioner (remote-exec):   linux-headers-4.15.0-159
null_resource.remote-provisioner (remote-exec): Use 'sudo apt autoremove' to remove it.
null_resource.remote-provisioner (remote-exec): 0 upgraded, 0 newly installed, 0 to remove and 8 not upgraded.
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 100%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... Done
null_resource.remote-provisioner (remote-exec): libffi-dev is already the newest version (3.2.1-8).
null_resource.remote-provisioner (remote-exec): python-dev is already the newest version (2.7.15~rc1-1).
null_resource.remote-provisioner (remote-exec): python-setuptools is already the newest version (39.0.1-2).
null_resource.remote-provisioner (remote-exec): sshpass is already the newest version (1.06-1).
null_resource.remote-provisioner (remote-exec): tree is already the newest version (1.7.0-5).
null_resource.remote-provisioner (remote-exec): git is already the newest version (1:2.17.1-1ubuntu0.9).
null_resource.remote-provisioner (remote-exec): libssl-dev is already the newest version (1.1.1-1ubuntu2.1~18.04.13).
null_resource.remote-provisioner (remote-exec): The following package was automatically installed and is no longer required:
null_resource.remote-provisioner (remote-exec):   linux-headers-4.15.0-159
null_resource.remote-provisioner (remote-exec): Use 'sudo apt autoremove' to remove it.
null_resource.remote-provisioner (remote-exec): 0 upgraded, 0 newly installed, 0 to remove and 8 not upgraded.
null_resource.remote-provisioner (remote-exec): sudo: easy_install: command not found
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 100%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... Done
null_resource.remote-provisioner (remote-exec): ansible is already the newest version (2.5.1+dfsg-1ubuntu0.1).
null_resource.remote-provisioner (remote-exec): The following package was automatically installed and is no longer required:
null_resource.remote-provisioner (remote-exec):   linux-headers-4.15.0-159
null_resource.remote-provisioner (remote-exec): Use 'sudo apt autoremove' to remove it.
null_resource.remote-provisioner (remote-exec): 0 upgraded, 0 newly installed, 0 to remove and 8 not upgraded.
null_resource.remote-provisioner (remote-exec): ansible 2.5.1
null_resource.remote-provisioner (remote-exec):   config file = /etc/ansible/ansible.cfg
null_resource.remote-provisioner (remote-exec):   configured module search path = [u'/home/admatic/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']
null_resource.remote-provisioner (remote-exec):   ansible python module location = /usr/lib/python2.7/dist-packages/ansible
null_resource.remote-provisioner (remote-exec):   executable location = /usr/bin/ansible
null_resource.remote-provisioner (remote-exec):   python version = 2.7.17 (default, Feb 27 2021, 15:10:58) [GCC 7.5.0]
null_resource.remote-provisioner (remote-exec): total 40
null_resource.remote-provisioner (remote-exec): -rw-rw-r-- 1 admatic admatic   28 Oct 11 07:12 remoteexec.txt
null_resource.remote-provisioner (remote-exec): drwx------ 2 admatic admatic 4096 Oct 11 07:12 ssh-0CzlyyRclv
null_resource.remote-provisioner (remote-exec): drwx------ 2 admatic admatic 4096 Oct 11 07:12 ssh-4doPITgzNe
null_resource.remote-provisioner (remote-exec): drwx------ 2 admatic admatic 4096 Oct 11 07:12 ssh-BhbeXvWUhu
null_resource.remote-provisioner (remote-exec): drwx------ 3 root    root    4096 Oct 11 07:06 systemd-private-cfcef15b9f714e9c9a7704483e184814-apache2.service-AIhDjz
null_resource.remote-provisioner (remote-exec): drwx------ 3 root    root    4096 Oct 11 07:04 systemd-private-cfcef15b9f714e9c9a7704483e184814-systemd-resolved.service-9Gu3bE
null_resource.remote-provisioner (remote-exec): drwx------ 3 root    root    4096 Oct 11 06:37 systemd-private-cfcef15b9f714e9c9a7704483e184814-systemd-timesyncd.service-ClHX9T
null_resource.remote-provisioner (remote-exec): -rwxrwxrwx 1 admatic admatic  220 Oct 11 07:06 terraform_2008135682.sh
null_resource.remote-provisioner (remote-exec): -rwxrwxrwx 1 admatic admatic  221 Oct 11 07:12 terraform_21525387.sh
null_resource.remote-provisioner (remote-exec): -rwxrwxrwx 1 admatic admatic  220 Oct 11 07:09 terraform_64422593.sh
null_resource.remote-provisioner (remote-exec): ERROR! the playbook: admatic-playbook.yaml could not be found
╷
│ Error: remote-exec provisioner error
│ 
│   with null_resource.remote-provisioner,
│   on main.tf line 117, in resource "null_resource" "remote-provisioner":
│  117: 	provisioner "remote-exec" {
│ 
│ error executing "/tmp/terraform_21525387.sh": Process exited with status 1
╵
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ vi main.tf 
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ cat main.tf
provider "azurerm" {
	features {}
}

resource "azurerm_resource_group" "myterraformgroup" {
    name     = "myResourceGroup"
    location = "eastus"
}

resource "azurerm_virtual_network" "myterraformnetwork" {
	name = "myVnet"
	address_space = ["10.0.0.0/16"]
	location = "eastus"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
}

resource "azurerm_public_ip" "myterraformpublicip" {
    name                         = "myPublicIP"
    location                     = "eastus"
    resource_group_name          = azurerm_resource_group.myterraformgroup.name
    allocation_method            = "Dynamic"
}


resource "azurerm_subnet" "myterraformsubnet" {
	name = "mySubnet"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
	virtual_network_name = azurerm_virtual_network.myterraformnetwork.name
	address_prefixes = ["10.0.1.0/24"]
}

resource "azurerm_network_security_group" "myterraformnsg" {
    name                = "myNetworkSecurityGroup"
    location            = "eastus"
    resource_group_name = azurerm_resource_group.myterraformgroup.name

    security_rule {
        name                       = "Web"
        priority                   = 1001
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "Tcp"
        source_port_range          = "*"
        destination_port_range     = "22"
        source_address_prefix      = "*"
        destination_address_prefix = "*"
    }
}

resource "azurerm_network_interface" "myterraformnic" {
    name                      = "myNIC"
    location                  = "eastus"
    resource_group_name       = azurerm_resource_group.myterraformgroup.name

    ip_configuration {
        name                          = "myNicConfiguration"
        subnet_id                     = azurerm_subnet.myterraformsubnet.id
        private_ip_address_allocation = "Dynamic"
        public_ip_address_id          = azurerm_public_ip.myterraformpublicip.id
    }
}


resource "azurerm_network_interface_security_group_association" "example" {
    network_interface_id      = azurerm_network_interface.myterraformnic.id
    network_security_group_id = azurerm_network_security_group.myterraformnsg.id
}


resource "azurerm_linux_virtual_machine" "myterraformvm" {
    name                  = "admaticmyVM"
    location              = "eastus"
    resource_group_name   = azurerm_resource_group.myterraformgroup.name
    network_interface_ids = [azurerm_network_interface.myterraformnic.id]
    #size                  = "Standard_DS1_v2"
    size                  = "Standard_B1s"

    os_disk {
        name              = "myOsDisk"
        caching           = "ReadWrite"
        storage_account_type = "Premium_LRS"
    }

    source_image_reference {
        publisher = "Canonical"
        offer     = "UbuntuServer"
        sku       = "18.04-LTS"
        version   = "latest"
    }

    admin_username = "admatic"
    admin_password = "Sincere-Compete-Spoil-Private-3"
    disable_password_authentication = false
    

}

output "public_ip" {
  value = azurerm_public_ip.myterraformpublicip.ip_address
  description = "The public IP address of the vm"
}

resource "null_resource" "remote-provisioner" {
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "remote-exec" {
		inline = [
			"echo Remote Provisioner did this > /tmp/remoteexec.txt",
			"echo Remote Provisioner Completed first execution ",
			"sh /home/admatic/robochef_stack.sh",
			"ls -l /tmp",
			"cd /home/admatic && ansible-playbook ansible-playbook.yaml"
			]
	}
	depends_on = [null_resource.copy_script,null_resource.copy_playbook]

}

resource "null_resource" "copy_script" {
	
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "file" {
		source = "robochef_stack.sh"
		destination = "/home/admatic/robochef_stack.sh"
	}

}

resource "null_resource" "copy_playbook" {

        triggers = {
                trigger = timestamp()

        }
        connection {
                type = "ssh"
                host = azurerm_public_ip.myterraformpublicip.ip_address
                user = "admatic"
                password ="Sincere-Compete-Spoil-Private-3"
                port = 22
                agent = true

        }
        provisioner "file" {
                source = "files/ansible-playbook.yaml"
                destination = "/home/admatic/ansible-playbook.yaml"
        }

}


saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ terraform apply --auto-approve
azurerm_resource_group.myterraformgroup: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup]
azurerm_public_ip.myterraformpublicip: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP]
azurerm_virtual_network.myterraformnetwork: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet]
azurerm_network_security_group.myterraformnsg: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup]
azurerm_subnet.myterraformsubnet: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet]
null_resource.copy_playbook: Refreshing state... [id=7032563699647622175]
null_resource.copy_script: Refreshing state... [id=7882599186433748529]
null_resource.remote-provisioner: Refreshing state... [id=4998225259721161073]
azurerm_network_interface.myterraformnic: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC]
azurerm_network_interface_security_group_association.example: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC|/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup]
azurerm_linux_virtual_machine.myterraformvm: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/admaticmyVM]

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the
following symbols:
-/+ destroy and then create replacement

Terraform will perform the following actions:

  # null_resource.copy_playbook must be replaced
-/+ resource "null_resource" "copy_playbook" {
      ~ id       = "7032563699647622175" -> (known after apply)
      ~ triggers = {
          - "trigger" = "2021-10-11T07:12:17Z"
        } -> (known after apply) # forces replacement
    }

  # null_resource.copy_script must be replaced
-/+ resource "null_resource" "copy_script" {
      ~ id       = "7882599186433748529" -> (known after apply)
      ~ triggers = {
          - "trigger" = "2021-10-11T07:12:17Z"
        } -> (known after apply) # forces replacement
    }

  # null_resource.remote-provisioner is tainted, so must be replaced
-/+ resource "null_resource" "remote-provisioner" {
      ~ id       = "4998225259721161073" -> (known after apply)
      ~ triggers = {
          - "trigger" = "2021-10-11T07:12:22Z"
        } -> (known after apply)
    }

Plan: 3 to add, 0 to change, 3 to destroy.
null_resource.remote-provisioner: Destroying... [id=4998225259721161073]
null_resource.remote-provisioner: Destruction complete after 0s
null_resource.copy_script: Destroying... [id=7882599186433748529]
null_resource.copy_playbook: Destroying... [id=7032563699647622175]
null_resource.copy_script: Destruction complete after 0s
null_resource.copy_playbook: Destruction complete after 0s
null_resource.copy_script: Creating...
null_resource.copy_playbook: Creating...
null_resource.copy_playbook: Provisioning with 'file'...
null_resource.copy_script: Provisioning with 'file'...
null_resource.copy_script: Creation complete after 5s [id=1829465829513559145]
null_resource.copy_playbook: Creation complete after 5s [id=3972041246443394362]
null_resource.remote-provisioner: Creating...
null_resource.remote-provisioner: Provisioning with 'remote-exec'...
null_resource.remote-provisioner (remote-exec): Connecting to remote host via SSH...
null_resource.remote-provisioner (remote-exec):   Host: 13.68.144.196
null_resource.remote-provisioner (remote-exec):   User: admatic
null_resource.remote-provisioner (remote-exec):   Password: true
null_resource.remote-provisioner (remote-exec):   Private key: false
null_resource.remote-provisioner (remote-exec):   Certificate: false
null_resource.remote-provisioner (remote-exec):   SSH Agent: true
null_resource.remote-provisioner (remote-exec):   Checking Host Key: false
null_resource.remote-provisioner (remote-exec):   Target Platform: unix
null_resource.remote-provisioner (remote-exec): Connected!
null_resource.remote-provisioner (remote-exec): Remote Provisioner Completed first execution
null_resource.remote-provisioner (remote-exec): beginning the execution of robochef stack
null_resource.remote-provisioner (remote-exec): 
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): Hit:1 http://azure.archive.ubuntu.com/ubuntu bionic InRelease
null_resource.remote-provisioner (remote-exec): 
null_resource.remote-provisioner (remote-exec): 0% [Connecting to security.ubuntu.com (
null_resource.remote-provisioner (remote-exec): Get:2 http://azure.archive.ubuntu.com/ubuntu bionic-updates InRelease [88.7 kB]
null_resource.remote-provisioner (remote-exec): Get:3 http://azure.archive.ubuntu.com/ubuntu bionic-backports InRelease [74.6 kB]
null_resource.remote-provisioner (remote-exec): 
null_resource.remote-provisioner (remote-exec): 0% [3 InRelease 74.6 kB/74.6 kB 100%] [
null_resource.remote-provisioner (remote-exec): 0% [Waiting for headers]
null_resource.remote-provisioner (remote-exec): 0% [1 InRelease gpgv 242 kB] [Waiting f
null_resource.remote-provisioner (remote-exec): Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease
null_resource.remote-provisioner (remote-exec): 
null_resource.remote-provisioner (remote-exec): 0% [1 InRelease gpgv 242 kB]
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): 0% [2 InRelease gpgv 88.7 kB]
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): 0% [3 InRelease gpgv 74.6 kB]
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): 0% [4 InRelease gpgv 88.7 kB]
null_resource.remote-provisioner (remote-exec): 100% [Working]
null_resource.remote-provisioner (remote-exec): Fetched 163 kB in 0s (360 kB/s)
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 3%
null_resource.remote-provisioner (remote-exec): Reading package lists... 3%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 35%
null_resource.remote-provisioner (remote-exec): Reading package lists... 37%
null_resource.remote-provisioner (remote-exec): Reading package lists... 37%
null_resource.remote-provisioner (remote-exec): Reading package lists... 53%
null_resource.remote-provisioner (remote-exec): Reading package lists... 53%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 62%
null_resource.remote-provisioner (remote-exec): Reading package lists... 62%
null_resource.remote-provisioner (remote-exec): Reading package lists... 67%
null_resource.remote-provisioner (remote-exec): Reading package lists... 67%
null_resource.remote-provisioner (remote-exec): Reading package lists... 69%
null_resource.remote-provisioner (remote-exec): Reading package lists... 69%
null_resource.remote-provisioner (remote-exec): Reading package lists... 70%
null_resource.remote-provisioner (remote-exec): Reading package lists... 70%
null_resource.remote-provisioner (remote-exec): Reading package lists... 76%
null_resource.remote-provisioner (remote-exec): Reading package lists... 76%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 86%
null_resource.remote-provisioner (remote-exec): Reading package lists... 86%
null_resource.remote-provisioner (remote-exec): Reading package lists... 91%
null_resource.remote-provisioner (remote-exec): Reading package lists... 91%
null_resource.remote-provisioner (remote-exec): Reading package lists... 92%
null_resource.remote-provisioner (remote-exec): Reading package lists... 92%
null_resource.remote-provisioner (remote-exec): Reading package lists... 93%
null_resource.remote-provisioner (remote-exec): Reading package lists... 93%
null_resource.remote-provisioner (remote-exec): Reading package lists... 97%
null_resource.remote-provisioner (remote-exec): Reading package lists... 97%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... Done
null_resource.remote-provisioner (remote-exec): 8 packages can be upgraded. Run 'apt list --upgradable' to see them.
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 100%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... Done
null_resource.remote-provisioner (remote-exec): apache2 is already the newest version (2.4.29-1ubuntu4.19).
null_resource.remote-provisioner (remote-exec): The following package was automatically installed and is no longer required:
null_resource.remote-provisioner (remote-exec):   linux-headers-4.15.0-159
null_resource.remote-provisioner (remote-exec): Use 'sudo apt autoremove' to remove it.
null_resource.remote-provisioner (remote-exec): 0 upgraded, 0 newly installed, 0 to remove and 8 not upgraded.
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): Hit:1 http://azure.archive.ubuntu.com/ubuntu bionic InRelease
null_resource.remote-provisioner (remote-exec): 0% [Connecting to security.ubuntu.com (
null_resource.remote-provisioner (remote-exec): Hit:2 http://azure.archive.ubuntu.com/ubuntu bionic-updates InRelease
null_resource.remote-provisioner (remote-exec): Hit:3 http://azure.archive.ubuntu.com/ubuntu bionic-backports InRelease
null_resource.remote-provisioner (remote-exec): 0% [Waiting for headers]
null_resource.remote-provisioner (remote-exec): 0% [1 InRelease gpgv 242 kB] [Waiting f
null_resource.remote-provisioner (remote-exec): Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease
null_resource.remote-provisioner (remote-exec): 0% [1 InRelease gpgv 242 kB]
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): 0% [2 InRelease gpgv 88.7 kB]
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): 0% [3 InRelease gpgv 74.6 kB]
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): 0% [4 InRelease gpgv 88.7 kB]
null_resource.remote-provisioner (remote-exec): 20% [Working]
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 3%
null_resource.remote-provisioner (remote-exec): Reading package lists... 3%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 36%
null_resource.remote-provisioner (remote-exec): Reading package lists... 37%
null_resource.remote-provisioner (remote-exec): Reading package lists... 37%
null_resource.remote-provisioner (remote-exec): Reading package lists... 53%
null_resource.remote-provisioner (remote-exec): Reading package lists... 53%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner: Still creating... [10s elapsed]
null_resource.remote-provisioner (remote-exec): Reading package lists... 62%
null_resource.remote-provisioner (remote-exec): Reading package lists... 62%
null_resource.remote-provisioner (remote-exec): Reading package lists... 67%
null_resource.remote-provisioner (remote-exec): Reading package lists... 67%
null_resource.remote-provisioner (remote-exec): Reading package lists... 69%
null_resource.remote-provisioner (remote-exec): Reading package lists... 69%
null_resource.remote-provisioner (remote-exec): Reading package lists... 70%
null_resource.remote-provisioner (remote-exec): Reading package lists... 70%
null_resource.remote-provisioner (remote-exec): Reading package lists... 76%
null_resource.remote-provisioner (remote-exec): Reading package lists... 76%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 86%
null_resource.remote-provisioner (remote-exec): Reading package lists... 86%
null_resource.remote-provisioner (remote-exec): Reading package lists... 91%
null_resource.remote-provisioner (remote-exec): Reading package lists... 91%
null_resource.remote-provisioner (remote-exec): Reading package lists... 92%
null_resource.remote-provisioner (remote-exec): Reading package lists... 92%
null_resource.remote-provisioner (remote-exec): Reading package lists... 93%
null_resource.remote-provisioner (remote-exec): Reading package lists... 93%
null_resource.remote-provisioner (remote-exec): Reading package lists... 97%
null_resource.remote-provisioner (remote-exec): Reading package lists... 97%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 100%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... Done
null_resource.remote-provisioner (remote-exec): software-properties-common is already the newest version (0.96.24.32.14).
null_resource.remote-provisioner (remote-exec): The following package was automatically installed and is no longer required:
null_resource.remote-provisioner (remote-exec):   linux-headers-4.15.0-159
null_resource.remote-provisioner (remote-exec): Use 'sudo apt autoremove' to remove it.
null_resource.remote-provisioner (remote-exec): 0 upgraded, 0 newly installed, 0 to remove and 8 not upgraded.
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 100%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... Done
null_resource.remote-provisioner (remote-exec): libffi-dev is already the newest version (3.2.1-8).
null_resource.remote-provisioner (remote-exec): python-dev is already the newest version (2.7.15~rc1-1).
null_resource.remote-provisioner (remote-exec): python-setuptools is already the newest version (39.0.1-2).
null_resource.remote-provisioner (remote-exec): sshpass is already the newest version (1.06-1).
null_resource.remote-provisioner (remote-exec): tree is already the newest version (1.7.0-5).
null_resource.remote-provisioner (remote-exec): git is already the newest version (1:2.17.1-1ubuntu0.9).
null_resource.remote-provisioner (remote-exec): libssl-dev is already the newest version (1.1.1-1ubuntu2.1~18.04.13).
null_resource.remote-provisioner (remote-exec): The following package was automatically installed and is no longer required:
null_resource.remote-provisioner (remote-exec):   linux-headers-4.15.0-159
null_resource.remote-provisioner (remote-exec): Use 'sudo apt autoremove' to remove it.
null_resource.remote-provisioner (remote-exec): 0 upgraded, 0 newly installed, 0 to remove and 8 not upgraded.
null_resource.remote-provisioner (remote-exec): sudo: easy_install: command not found
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 100%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... Done
null_resource.remote-provisioner (remote-exec): ansible is already the newest version (2.5.1+dfsg-1ubuntu0.1).
null_resource.remote-provisioner (remote-exec): The following package was automatically installed and is no longer required:
null_resource.remote-provisioner (remote-exec):   linux-headers-4.15.0-159
null_resource.remote-provisioner (remote-exec): Use 'sudo apt autoremove' to remove it.
null_resource.remote-provisioner (remote-exec): 0 upgraded, 0 newly installed, 0 to remove and 8 not upgraded.
null_resource.remote-provisioner (remote-exec): ansible 2.5.1
null_resource.remote-provisioner (remote-exec):   config file = /etc/ansible/ansible.cfg
null_resource.remote-provisioner (remote-exec):   configured module search path = [u'/home/admatic/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']
null_resource.remote-provisioner (remote-exec):   ansible python module location = /usr/lib/python2.7/dist-packages/ansible
null_resource.remote-provisioner (remote-exec):   executable location = /usr/bin/ansible
null_resource.remote-provisioner (remote-exec):   python version = 2.7.17 (default, Feb 27 2021, 15:10:58) [GCC 7.5.0]
null_resource.remote-provisioner (remote-exec): total 44
null_resource.remote-provisioner (remote-exec): -rw-rw-r-- 1 admatic admatic   28 Oct 11 07:15 remoteexec.txt
null_resource.remote-provisioner (remote-exec): drwx------ 2 admatic admatic 4096 Oct 11 07:15 ssh-DvQTQJNC9Q
null_resource.remote-provisioner (remote-exec): drwx------ 2 admatic admatic 4096 Oct 11 07:15 ssh-TDT3TehC1r
null_resource.remote-provisioner (remote-exec): drwx------ 2 admatic admatic 4096 Oct 11 07:15 ssh-wQExBkBhEk
null_resource.remote-provisioner (remote-exec): drwx------ 3 root    root    4096 Oct 11 07:06 systemd-private-cfcef15b9f714e9c9a7704483e184814-apache2.service-AIhDjz
null_resource.remote-provisioner (remote-exec): drwx------ 3 root    root    4096 Oct 11 07:04 systemd-private-cfcef15b9f714e9c9a7704483e184814-systemd-resolved.service-9Gu3bE
null_resource.remote-provisioner (remote-exec): drwx------ 3 root    root    4096 Oct 11 06:37 systemd-private-cfcef15b9f714e9c9a7704483e184814-systemd-timesyncd.service-ClHX9T
null_resource.remote-provisioner (remote-exec): -rwxrwxrwx 1 admatic admatic  221 Oct 11 07:15 terraform_1301115383.sh
null_resource.remote-provisioner (remote-exec): -rwxrwxrwx 1 admatic admatic  220 Oct 11 07:06 terraform_2008135682.sh
null_resource.remote-provisioner (remote-exec): -rwxrwxrwx 1 admatic admatic  221 Oct 11 07:12 terraform_21525387.sh
null_resource.remote-provisioner (remote-exec): -rwxrwxrwx 1 admatic admatic  220 Oct 11 07:09 terraform_64422593.sh
null_resource.remote-provisioner (remote-exec):  [WARNING]: provided hosts list is empty, only localhost is available. Note
null_resource.remote-provisioner (remote-exec): that the implicit localhost does not match 'all'
null_resource.remote-provisioner (remote-exec): 
null_resource.remote-provisioner (remote-exec): [DEPRECATION WARNING]: Instead of sudo/sudo_user, use become/become_user and 
null_resource.remote-provisioner (remote-exec): make sure become_method is 'sudo' (default). This feature will be removed in 
null_resource.remote-provisioner (remote-exec): version 2.6. Deprecation warnings can be disabled by setting 
null_resource.remote-provisioner (remote-exec): deprecation_warnings=False in ansible.cfg.

null_resource.remote-provisioner (remote-exec): PLAY [localhost] ***************************************************************

null_resource.remote-provisioner (remote-exec): TASK [Gathering Facts] *********************************************************
null_resource.remote-provisioner (remote-exec): ok: [localhost]

null_resource.remote-provisioner (remote-exec): TASK [setup a MOTD] ************************************************************
null_resource.remote-provisioner (remote-exec): changed: [localhost]

null_resource.remote-provisioner (remote-exec): PLAY RECAP *********************************************************************
null_resource.remote-provisioner (remote-exec): localhost                  : ok=2    changed=1    unreachable=0    failed=0

null_resource.remote-provisioner: Creation complete after 21s [id=5028531921685412260]

Apply complete! Resources: 3 added, 0 changed, 3 destroyed.

Outputs:

public_ip = "13.68.144.196"
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ ssh admatic@20.106.240.50
^C
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ ssh admatic@13.68.144.196
The authenticity of host '13.68.144.196 (13.68.144.196)' can't be established.
ECDSA key fingerprint is SHA256:NTopz8LXp2+adouUt/n5BFyJCK0C0nW7lRd+sAM/0Bo.
Are you sure you want to continue connecting (yes/no/[fingerprint])? ye^C                             
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ ssh admatic@13.68.144.196

The authenticity of host '13.68.144.196 (13.68.144.196)' can't be established.
ECDSA key fingerprint is SHA256:NTopz8LXp2+adouUt/n5BFyJCK0C0nW7lRd+sAM/0Bo.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '13.68.144.196' (ECDSA) to the list of known hosts.
admatic@13.68.144.196's password: 
Welcome to Ubuntu 18.04.6 LTS (GNU/Linux 5.4.0-1059-azure x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Mon Oct 11 07:17:26 UTC 2021

  System load:  0.08              Processes:           112
  Usage of /:   6.0% of 28.90GB   Users logged in:     0
  Memory usage: 26%               IP address for eth0: 10.0.1.4
  Swap usage:   0%


8 updates can be applied immediately.
4 of these updates are standard security updates.
To see these additional updates run: apt list --upgradable

New release '20.04.3 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


RoboChef the worlds First fully automated Robbotic Kitchen
Last login: Mon Oct 11 07:15:36 2021 from 49.37.223.189
admatic@admaticmyVM:~$ ls /opt/ -tr1
admatic@admaticmyVM:~$ sudo !!
sudo ls /opt/ -tr1
admatic@admaticmyVM:~$ cat ansible-playbook.yaml 
---
- hosts: localhost
  sudo: yes
  vars:
    motd_warning: 'RoboChef the worlds First fully automated Robbotic Kitchen'
  tasks:
    - name: setup a MOTD
      copy: dest=/etc/motd content={{ motd_warning }}


admatic@admaticmyVM:~$ cat /etc/motd 
RoboChef the worlds First fully automated Robbotic Kitchenadmatic@admaticmyVM:~$ logout
Connection to 13.68.144.196 closed.
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ 
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ vi files/ansible-playbook.yaml 
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ cat files/ansible-playbook.yaml
---
- hosts: localhost
  sudo: yes
  vars:
    motd_warning: 'RoboChef the worlds First fully automated Robbotic Kitchen'
    admatic_note: 'Admatic works'
  tasks:
    - name: setup a MOTD
      copy: dest=/etc/motd content={{ motd_warning }}
    - name: Another task to demonsntrate ansible from terraform 
      copy: dest=/opt/admaticworks content={{ motd_warning }}


saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ vi files/ansible-playbook.yaml 
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ cat files/ansible-playbook.yaml
---
- hosts: localhost
  sudo: yes
  vars:
    motd_warning: 'RoboChef the worlds First fully automated Robbotic Kitchen'
    admatic_note: 'Admatic works'
  tasks:
    - name: setup a MOTD
      copy: dest=/etc/motd content={{ motd_warning }}
    - name: Another task to demonsntrate ansible from terraform 
      copy: dest=/opt/admaticworks content={{ admatic_note }}


saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ terraform apply --auto-approve
azurerm_resource_group.myterraformgroup: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup]
azurerm_public_ip.myterraformpublicip: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP]
azurerm_virtual_network.myterraformnetwork: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet]
azurerm_network_security_group.myterraformnsg: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup]
azurerm_subnet.myterraformsubnet: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet]
null_resource.copy_playbook: Refreshing state... [id=3972041246443394362]
azurerm_network_interface.myterraformnic: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC]
null_resource.copy_script: Refreshing state... [id=1829465829513559145]
null_resource.remote-provisioner: Refreshing state... [id=5028531921685412260]
azurerm_linux_virtual_machine.myterraformvm: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/admaticmyVM]
azurerm_network_interface_security_group_association.example: Refreshing state... [id=/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNIC|/subscriptions/17801c1a-831f-43c1-8d8a-7da5270619d6/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup]

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the
following symbols:
-/+ destroy and then create replacement

Terraform will perform the following actions:

  # null_resource.copy_playbook must be replaced
-/+ resource "null_resource" "copy_playbook" {
      ~ id       = "3972041246443394362" -> (known after apply)
      ~ triggers = {
          - "trigger" = "2021-10-11T07:15:25Z"
        } -> (known after apply) # forces replacement
    }

  # null_resource.copy_script must be replaced
-/+ resource "null_resource" "copy_script" {
      ~ id       = "1829465829513559145" -> (known after apply)
      ~ triggers = {
          - "trigger" = "2021-10-11T07:15:25Z"
        } -> (known after apply) # forces replacement
    }

  # null_resource.remote-provisioner must be replaced
-/+ resource "null_resource" "remote-provisioner" {
      ~ id       = "5028531921685412260" -> (known after apply)
      ~ triggers = {
          - "trigger" = "2021-10-11T07:15:29Z"
        } -> (known after apply) # forces replacement
    }

Plan: 3 to add, 0 to change, 3 to destroy.
null_resource.remote-provisioner: Destroying... [id=5028531921685412260]
null_resource.remote-provisioner: Destruction complete after 0s
null_resource.copy_script: Destroying... [id=1829465829513559145]
null_resource.copy_playbook: Destroying... [id=3972041246443394362]
null_resource.copy_playbook: Destruction complete after 0s
null_resource.copy_script: Destruction complete after 0s
null_resource.copy_script: Creating...
null_resource.copy_playbook: Creating...
null_resource.copy_script: Provisioning with 'file'...
null_resource.copy_playbook: Provisioning with 'file'...
null_resource.copy_script: Creation complete after 5s [id=4451336774682130824]
null_resource.copy_playbook: Creation complete after 5s [id=5617363240855199761]
null_resource.remote-provisioner: Creating...
null_resource.remote-provisioner: Provisioning with 'remote-exec'...
null_resource.remote-provisioner (remote-exec): Connecting to remote host via SSH...
null_resource.remote-provisioner (remote-exec):   Host: 13.68.144.196
null_resource.remote-provisioner (remote-exec):   User: admatic
null_resource.remote-provisioner (remote-exec):   Password: true
null_resource.remote-provisioner (remote-exec):   Private key: false
null_resource.remote-provisioner (remote-exec):   Certificate: false
null_resource.remote-provisioner (remote-exec):   SSH Agent: true
null_resource.remote-provisioner (remote-exec):   Checking Host Key: false
null_resource.remote-provisioner (remote-exec):   Target Platform: unix
null_resource.remote-provisioner (remote-exec): Connected!
null_resource.remote-provisioner (remote-exec): Remote Provisioner Completed first execution
null_resource.remote-provisioner (remote-exec): beginning the execution of robochef stack
null_resource.remote-provisioner (remote-exec): 
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): Hit:1 http://azure.archive.ubuntu.com/ubuntu bionic InRelease
null_resource.remote-provisioner (remote-exec): 
null_resource.remote-provisioner (remote-exec): 0% [Connecting to security.ubuntu.com (
null_resource.remote-provisioner (remote-exec): Hit:2 http://azure.archive.ubuntu.com/ubuntu bionic-updates InRelease
null_resource.remote-provisioner (remote-exec): Hit:3 http://azure.archive.ubuntu.com/ubuntu bionic-backports InRelease
null_resource.remote-provisioner (remote-exec): 
null_resource.remote-provisioner (remote-exec): 0% [Waiting for headers]
null_resource.remote-provisioner (remote-exec): 0% [1 InRelease gpgv 242 kB] [Waiting f
null_resource.remote-provisioner (remote-exec): 0% [Waiting for headers]
null_resource.remote-provisioner (remote-exec): 0% [2 InRelease gpgv 88.7 kB] [Waiting 
null_resource.remote-provisioner (remote-exec): Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease
null_resource.remote-provisioner (remote-exec): 
null_resource.remote-provisioner (remote-exec): 0% [2 InRelease gpgv 88.7 kB]
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): 0% [3 InRelease gpgv 74.6 kB]
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): 0% [4 InRelease gpgv 88.7 kB]
null_resource.remote-provisioner (remote-exec): 20% [Working]
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 3%
null_resource.remote-provisioner (remote-exec): Reading package lists... 3%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 37%
null_resource.remote-provisioner (remote-exec): Reading package lists... 37%
null_resource.remote-provisioner (remote-exec): Reading package lists... 37%
null_resource.remote-provisioner (remote-exec): Reading package lists... 53%
null_resource.remote-provisioner (remote-exec): Reading package lists... 53%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 62%
null_resource.remote-provisioner (remote-exec): Reading package lists... 62%
null_resource.remote-provisioner (remote-exec): Reading package lists... 67%
null_resource.remote-provisioner (remote-exec): Reading package lists... 67%
null_resource.remote-provisioner (remote-exec): Reading package lists... 69%
null_resource.remote-provisioner (remote-exec): Reading package lists... 69%
null_resource.remote-provisioner (remote-exec): Reading package lists... 70%
null_resource.remote-provisioner (remote-exec): Reading package lists... 70%
null_resource.remote-provisioner (remote-exec): Reading package lists... 76%
null_resource.remote-provisioner (remote-exec): Reading package lists... 76%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 86%
null_resource.remote-provisioner (remote-exec): Reading package lists... 86%
null_resource.remote-provisioner (remote-exec): Reading package lists... 91%
null_resource.remote-provisioner (remote-exec): Reading package lists... 91%
null_resource.remote-provisioner (remote-exec): Reading package lists... 92%
null_resource.remote-provisioner (remote-exec): Reading package lists... 92%
null_resource.remote-provisioner (remote-exec): Reading package lists... 93%
null_resource.remote-provisioner (remote-exec): Reading package lists... 93%
null_resource.remote-provisioner (remote-exec): Reading package lists... 97%
null_resource.remote-provisioner (remote-exec): Reading package lists... 97%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... Done
null_resource.remote-provisioner (remote-exec): 8 packages can be upgraded. Run 'apt list --upgradable' to see them.
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 100%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... Done
null_resource.remote-provisioner (remote-exec): apache2 is already the newest version (2.4.29-1ubuntu4.19).
null_resource.remote-provisioner (remote-exec): The following package was automatically installed and is no longer required:
null_resource.remote-provisioner (remote-exec):   linux-headers-4.15.0-159
null_resource.remote-provisioner (remote-exec): Use 'sudo apt autoremove' to remove it.
null_resource.remote-provisioner (remote-exec): 0 upgraded, 0 newly installed, 0 to remove and 8 not upgraded.
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): Hit:1 http://azure.archive.ubuntu.com/ubuntu bionic InRelease
null_resource.remote-provisioner (remote-exec): 0% [Connecting to security.ubuntu.com (
null_resource.remote-provisioner (remote-exec): Hit:2 http://azure.archive.ubuntu.com/ubuntu bionic-updates InRelease
null_resource.remote-provisioner (remote-exec): Hit:3 http://azure.archive.ubuntu.com/ubuntu bionic-backports InRelease
null_resource.remote-provisioner (remote-exec): 0% [Connecting to security.ubuntu.com (
null_resource.remote-provisioner (remote-exec): 0% [1 InRelease gpgv 242 kB] [Connectin
null_resource.remote-provisioner (remote-exec): 0% [Connecting to security.ubuntu.com (
null_resource.remote-provisioner (remote-exec): 0% [2 InRelease gpgv 88.7 kB] [Connecti
null_resource.remote-provisioner (remote-exec): 0% [Connecting to security.ubuntu.com (
null_resource.remote-provisioner (remote-exec): 0% [3 InRelease gpgv 74.6 kB] [Connecti
null_resource.remote-provisioner (remote-exec): Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease
null_resource.remote-provisioner (remote-exec): 0% [3 InRelease gpgv 74.6 kB]
null_resource.remote-provisioner (remote-exec): 0% [Working]
null_resource.remote-provisioner (remote-exec): 0% [4 InRelease gpgv 88.7 kB]
null_resource.remote-provisioner (remote-exec): 20% [Working]
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 3%
null_resource.remote-provisioner (remote-exec): Reading package lists... 3%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 5%
null_resource.remote-provisioner (remote-exec): Reading package lists... 37%
null_resource.remote-provisioner (remote-exec): Reading package lists... 37%
null_resource.remote-provisioner (remote-exec): Reading package lists... 39%
null_resource.remote-provisioner (remote-exec): Reading package lists... 53%
null_resource.remote-provisioner (remote-exec): Reading package lists... 53%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner (remote-exec): Reading package lists... 54%
null_resource.remote-provisioner: Still creating... [13s elapsed]
null_resource.remote-provisioner (remote-exec): Reading package lists... 62%
null_resource.remote-provisioner (remote-exec): Reading package lists... 62%
null_resource.remote-provisioner (remote-exec): Reading package lists... 67%
null_resource.remote-provisioner (remote-exec): Reading package lists... 67%
null_resource.remote-provisioner (remote-exec): Reading package lists... 69%
null_resource.remote-provisioner (remote-exec): Reading package lists... 69%
null_resource.remote-provisioner (remote-exec): Reading package lists... 70%
null_resource.remote-provisioner (remote-exec): Reading package lists... 70%
null_resource.remote-provisioner (remote-exec): Reading package lists... 76%
null_resource.remote-provisioner (remote-exec): Reading package lists... 76%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 79%
null_resource.remote-provisioner (remote-exec): Reading package lists... 86%
null_resource.remote-provisioner (remote-exec): Reading package lists... 86%
null_resource.remote-provisioner (remote-exec): Reading package lists... 91%
null_resource.remote-provisioner (remote-exec): Reading package lists... 91%
null_resource.remote-provisioner (remote-exec): Reading package lists... 92%
null_resource.remote-provisioner (remote-exec): Reading package lists... 92%
null_resource.remote-provisioner (remote-exec): Reading package lists... 93%
null_resource.remote-provisioner (remote-exec): Reading package lists... 93%
null_resource.remote-provisioner (remote-exec): Reading package lists... 97%
null_resource.remote-provisioner (remote-exec): Reading package lists... 97%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... 99%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 100%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... Done
null_resource.remote-provisioner (remote-exec): software-properties-common is already the newest version (0.96.24.32.14).
null_resource.remote-provisioner (remote-exec): The following package was automatically installed and is no longer required:
null_resource.remote-provisioner (remote-exec):   linux-headers-4.15.0-159
null_resource.remote-provisioner (remote-exec): Use 'sudo apt autoremove' to remove it.
null_resource.remote-provisioner (remote-exec): 0 upgraded, 0 newly installed, 0 to remove and 8 not upgraded.
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 100%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... Done
null_resource.remote-provisioner (remote-exec): libffi-dev is already the newest version (3.2.1-8).
null_resource.remote-provisioner (remote-exec): python-dev is already the newest version (2.7.15~rc1-1).
null_resource.remote-provisioner (remote-exec): python-setuptools is already the newest version (39.0.1-2).
null_resource.remote-provisioner (remote-exec): sshpass is already the newest version (1.06-1).
null_resource.remote-provisioner (remote-exec): tree is already the newest version (1.7.0-5).
null_resource.remote-provisioner (remote-exec): git is already the newest version (1:2.17.1-1ubuntu0.9).
null_resource.remote-provisioner (remote-exec): libssl-dev is already the newest version (1.1.1-1ubuntu2.1~18.04.13).
null_resource.remote-provisioner (remote-exec): The following package was automatically installed and is no longer required:
null_resource.remote-provisioner (remote-exec):   linux-headers-4.15.0-159
null_resource.remote-provisioner (remote-exec): Use 'sudo apt autoremove' to remove it.
null_resource.remote-provisioner (remote-exec): 0 upgraded, 0 newly installed, 0 to remove and 8 not upgraded.
null_resource.remote-provisioner (remote-exec): sudo: easy_install: command not found
null_resource.remote-provisioner (remote-exec): Reading package lists... 0%
null_resource.remote-provisioner (remote-exec): Reading package lists... 100%
null_resource.remote-provisioner (remote-exec): Reading package lists... Done
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 0%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree... 50%
null_resource.remote-provisioner (remote-exec): Building dependency tree
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... 0%
null_resource.remote-provisioner (remote-exec): Reading state information... Done
null_resource.remote-provisioner (remote-exec): ansible is already the newest version (2.5.1+dfsg-1ubuntu0.1).
null_resource.remote-provisioner (remote-exec): The following package was automatically installed and is no longer required:
null_resource.remote-provisioner (remote-exec):   linux-headers-4.15.0-159
null_resource.remote-provisioner (remote-exec): Use 'sudo apt autoremove' to remove it.
null_resource.remote-provisioner (remote-exec): 0 upgraded, 0 newly installed, 0 to remove and 8 not upgraded.
null_resource.remote-provisioner (remote-exec): ansible 2.5.1
null_resource.remote-provisioner (remote-exec):   config file = /etc/ansible/ansible.cfg
null_resource.remote-provisioner (remote-exec):   configured module search path = [u'/home/admatic/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']
null_resource.remote-provisioner (remote-exec):   ansible python module location = /usr/lib/python2.7/dist-packages/ansible
null_resource.remote-provisioner (remote-exec):   executable location = /usr/bin/ansible
null_resource.remote-provisioner (remote-exec):   python version = 2.7.17 (default, Feb 27 2021, 15:10:58) [GCC 7.5.0]
null_resource.remote-provisioner (remote-exec): total 44
null_resource.remote-provisioner (remote-exec): -rw-rw-r-- 1 admatic admatic   28 Oct 11 07:20 remoteexec.txt
null_resource.remote-provisioner (remote-exec): drwx------ 2 admatic admatic 4096 Oct 11 07:19 ssh-9OvB6O64JH
null_resource.remote-provisioner (remote-exec): drwx------ 2 admatic admatic 4096 Oct 11 07:19 ssh-WwAdlhPqyI
null_resource.remote-provisioner (remote-exec): drwx------ 2 admatic admatic 4096 Oct 11 07:19 ssh-yaEb1LAncT
null_resource.remote-provisioner (remote-exec): drwx------ 3 root    root    4096 Oct 11 07:06 systemd-private-cfcef15b9f714e9c9a7704483e184814-apache2.service-AIhDjz
null_resource.remote-provisioner (remote-exec): drwx------ 3 root    root    4096 Oct 11 07:04 systemd-private-cfcef15b9f714e9c9a7704483e184814-systemd-resolved.service-9Gu3bE
null_resource.remote-provisioner (remote-exec): drwx------ 3 root    root    4096 Oct 11 06:37 systemd-private-cfcef15b9f714e9c9a7704483e184814-systemd-timesyncd.service-ClHX9T
null_resource.remote-provisioner (remote-exec): -rwxrwxrwx 1 admatic admatic  221 Oct 11 07:19 terraform_1259334156.sh
null_resource.remote-provisioner (remote-exec): -rwxrwxrwx 1 admatic admatic    0 Oct 11 07:15 terraform_1301115383.sh
null_resource.remote-provisioner (remote-exec): -rwxrwxrwx 1 admatic admatic  220 Oct 11 07:06 terraform_2008135682.sh
null_resource.remote-provisioner (remote-exec): -rwxrwxrwx 1 admatic admatic  221 Oct 11 07:12 terraform_21525387.sh
null_resource.remote-provisioner (remote-exec): -rwxrwxrwx 1 admatic admatic  220 Oct 11 07:09 terraform_64422593.sh
null_resource.remote-provisioner (remote-exec):  [WARNING]: provided hosts list is empty, only localhost is available. Note
null_resource.remote-provisioner (remote-exec): that the implicit localhost does not match 'all'
null_resource.remote-provisioner (remote-exec): 
null_resource.remote-provisioner (remote-exec): [DEPRECATION WARNING]: Instead of sudo/sudo_user, use become/become_user and 
null_resource.remote-provisioner (remote-exec): make sure become_method is 'sudo' (default). This feature will be removed in 
null_resource.remote-provisioner (remote-exec): version 2.6. Deprecation warnings can be disabled by setting 
null_resource.remote-provisioner (remote-exec): deprecation_warnings=False in ansible.cfg.

null_resource.remote-provisioner (remote-exec): PLAY [localhost] ***************************************************************

null_resource.remote-provisioner (remote-exec): TASK [Gathering Facts] *********************************************************
null_resource.remote-provisioner (remote-exec): ok: [localhost]

null_resource.remote-provisioner (remote-exec): TASK [setup a MOTD] ************************************************************
null_resource.remote-provisioner (remote-exec): ok: [localhost]

null_resource.remote-provisioner (remote-exec): TASK [Another task to demonsntrate ansible from terraform] *********************
null_resource.remote-provisioner (remote-exec): changed: [localhost]

null_resource.remote-provisioner (remote-exec): PLAY RECAP *********************************************************************
null_resource.remote-provisioner (remote-exec): localhost                  : ok=3    changed=1    unreachable=0    failed=0

null_resource.remote-provisioner: Creation complete after 20s [id=8098242943381929524]

Apply complete! Resources: 3 added, 0 changed, 3 destroyed.

Outputs:

public_ip = "13.68.144.196"
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ ls
files  main.tf  robochef_stack.sh  robochef_stack.txt  terraform.tfstate  terraform.tfstate.backup
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ ssh admatic@13.68.144.196
admatic@13.68.144.196's password: 
Permission denied, please try again.
admatic@13.68.144.196's password: 
Welcome to Ubuntu 18.04.6 LTS (GNU/Linux 5.4.0-1059-azure x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Mon Oct 11 07:20:53 UTC 2021

  System load:  0.08              Processes:           114
  Usage of /:   6.0% of 28.90GB   Users logged in:     0
  Memory usage: 26%               IP address for eth0: 10.0.1.4
  Swap usage:   0%


8 updates can be applied immediately.
4 of these updates are standard security updates.
To see these additional updates run: apt list --upgradable

New release '20.04.3 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


RoboChef the worlds First fully automated Robbotic Kitchen
Last login: Mon Oct 11 07:20:01 2021 from 49.37.223.189
admatic@admaticmyVM:~$ ls /opt/
admaticworks
admatic@admaticmyVM:~$ 
admatic@admaticmyVM:~$ logout
Connection to 13.68.144.196 closed.
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ 
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ 

saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ tree .
.
├── files
│   └── ansible-playbook.yaml
├── main.tf
├── robochef_stack.sh
├── robochef_stack.txt
├── terraform.tfstate
└── terraform.tfstate.backup

1 directory, 6 files
saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ cat files/ansible-playbook.yaml 
---
- hosts: localhost
  sudo: yes
  vars:
    motd_warning: 'RoboChef the worlds First fully automated Robbotic Kitchen'
    admatic_note: 'Admatic works'
  tasks:
    - name: setup a MOTD
      copy: dest=/etc/motd content={{ motd_warning }}
    - name: Another task to demonsntrate ansible from terraform 
      copy: dest=/opt/admaticworks content={{ admatic_note }}


saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ cat robochef_stack.sh 
echo "beginning the execution of robochef stack"
sudo apt update
sudo apt install apache2 -y
sudo apt-get update
sudo apt-get install -y software-properties-common
sudo apt-get install -y python-setuptools python-dev libffi-dev libssl-dev git sshpass tree
sudo easy_install pip
sudo apt install ansible -y

ansible --version


saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ cat main.tf 
provider "azurerm" {
	features {}
}

resource "azurerm_resource_group" "myterraformgroup" {
    name     = "myResourceGroup"
    location = "eastus"
}

resource "azurerm_virtual_network" "myterraformnetwork" {
	name = "myVnet"
	address_space = ["10.0.0.0/16"]
	location = "eastus"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
}

resource "azurerm_public_ip" "myterraformpublicip" {
    name                         = "myPublicIP"
    location                     = "eastus"
    resource_group_name          = azurerm_resource_group.myterraformgroup.name
    allocation_method            = "Dynamic"
}


resource "azurerm_subnet" "myterraformsubnet" {
	name = "mySubnet"
	resource_group_name = azurerm_resource_group.myterraformgroup.name
	virtual_network_name = azurerm_virtual_network.myterraformnetwork.name
	address_prefixes = ["10.0.1.0/24"]
}

resource "azurerm_network_security_group" "myterraformnsg" {
    name                = "myNetworkSecurityGroup"
    location            = "eastus"
    resource_group_name = azurerm_resource_group.myterraformgroup.name

    security_rule {
        name                       = "Web"
        priority                   = 1001
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "Tcp"
        source_port_range          = "*"
        destination_port_range     = "22"
        source_address_prefix      = "*"
        destination_address_prefix = "*"
    }
}

resource "azurerm_network_interface" "myterraformnic" {
    name                      = "myNIC"
    location                  = "eastus"
    resource_group_name       = azurerm_resource_group.myterraformgroup.name

    ip_configuration {
        name                          = "myNicConfiguration"
        subnet_id                     = azurerm_subnet.myterraformsubnet.id
        private_ip_address_allocation = "Dynamic"
        public_ip_address_id          = azurerm_public_ip.myterraformpublicip.id
    }
}


resource "azurerm_network_interface_security_group_association" "example" {
    network_interface_id      = azurerm_network_interface.myterraformnic.id
    network_security_group_id = azurerm_network_security_group.myterraformnsg.id
}


resource "azurerm_linux_virtual_machine" "myterraformvm" {
    name                  = "admaticmyVM"
    location              = "eastus"
    resource_group_name   = azurerm_resource_group.myterraformgroup.name
    network_interface_ids = [azurerm_network_interface.myterraformnic.id]
    #size                  = "Standard_DS1_v2"
    size                  = "Standard_B1s"

    os_disk {
        name              = "myOsDisk"
        caching           = "ReadWrite"
        storage_account_type = "Premium_LRS"
    }

    source_image_reference {
        publisher = "Canonical"
        offer     = "UbuntuServer"
        sku       = "18.04-LTS"
        version   = "latest"
    }

    admin_username = "admatic"
    admin_password = "Sincere-Compete-Spoil-Private-3"
    disable_password_authentication = false
    

}

output "public_ip" {
  value = azurerm_public_ip.myterraformpublicip.ip_address
  description = "The public IP address of the vm"
}

resource "null_resource" "remote-provisioner" {
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "remote-exec" {
		inline = [
			"echo Remote Provisioner did this > /tmp/remoteexec.txt",
			"echo Remote Provisioner Completed first execution ",
			"sh /home/admatic/robochef_stack.sh",
			"ls -l /tmp",
			"cd /tmp && ansible-playbook ansible-playbook.yaml"
			]
	}
	depends_on = [null_resource.copy_script,null_resource.copy_playbook]

}

resource "null_resource" "copy_script" {
	
	triggers = {
		trigger = timestamp()

	}
	connection {
		type = "ssh"
		host = azurerm_public_ip.myterraformpublicip.ip_address
		user = "admatic"
		password ="Sincere-Compete-Spoil-Private-3"
		port = 22
		agent = true

	}
	provisioner "file" {
		source = "robochef_stack.sh"
		destination = "/home/admatic/robochef_stack.sh"
	}

}

resource "null_resource" "copy_playbook" {

        triggers = {
                trigger = timestamp()

        }
        connection {
                type = "ssh"
                host = azurerm_public_ip.myterraformpublicip.ip_address
                user = "admatic"
                password ="Sincere-Compete-Spoil-Private-3"
                port = 22
                agent = true

        }
        provisioner "file" {
                source = "files/ansible-playbook.yaml"
                destination = "/home/admatic/ansible-playbook.yaml"
        }

}


saravanans@ubuntu:~/admatic_terraform_workspace/remoteexec_demo$ 





